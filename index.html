<!DOCTYPE html>
<!-- MIT License
Copyright (c) 2025-2026 masaru-ster

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE. -->
<html><head>
  <meta charset="UTF-8">
  <title>MSRå¼ç®±åº­ã‚²ãƒ¼ãƒ ã€€Ver.4.6</title>
  <style>
  body { font-family: sans-serif; }
    table { border-collapse: collapse; }
  td {
    width: 23px;
    height: 23px;
    border: 1px solid #aaa;
    text-align: center;
    cursor: pointer;
  }
  .selected {
    outline: 4px solid gray;
    outline-offset: -1px;
  }
.action-link {
    cursor: pointer;
    color: blue;
    text-decoration: underline;
}
.next-action {
    color: #012073 !important;
}
.sea { background-color: #66b3ff; }
.port { background-color: #1f78b4; }
.oilRig { background: linear-gradient(#66b3ff, #004b8d); }
.plain { background-color: #dfffcc; }
.waste { background-color: #bbbbbb; }
.forest { background-color: #228B22; }
.mountain { background: linear-gradient(#705335, #4b3621); }
.farm { background-color: #b5e07a; }
.house { background-color: #fff3c4; }
.factory { background-color: #ccccff; }
.gun { background-color: #666666; }
.defenseFacility { background-color: #ff77aa; }
.Monument { background-color: #d4c17d; }
.warship { background: linear-gradient(#66b3ff, #4682B4); }
.warship-dispatched { background-color: #002f5f; color: #fff; }
.warship-wreckage { background-color: #333; color: #ccc; }
.selected {
    border: 2px solid gray !important;
  }
  .log-red {
    color: red;
  }
  .log-cyan {
    color: blue;
  }
  #warshipBuildInputs {
      display: none;
      margin-top: 1em;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #f9f9f9;
  }
  #warshipBuildInputs label {
      display: inline-block;
      width: 100px;
      margin-bottom: 5px;
  }
  #warshipBuildInputs input[type="text"],
  #warshipBuildInputs input[type="number"] {
      width: 150px;
      margin-bottom: 5px;
  }
  .warship-name-cap-2 {
    color: green;
  }
  .warship-name-cap-3 {
    color: blue;
  }
  .warship-name-cap-4 {
    color: purple;
  }
  .warship-name-cap-5 {
    color: red;
  }
 .warship-sp {
    color: orange;
  }
  </style>
</head>
<body>
<div id="gameControls" style="margin-bottom: 1em;">
  <label for="islandNameInput">å³¶ã®åå‰:</label>
  <input type="text" id="islandNameInput" value="MyIsland">
  <button onclick="saveGame()">ã‚»ãƒ¼ãƒ–</button>
  <button onclick="loadGame()">ãƒ­ãƒ¼ãƒ‰</button>
  <textarea id="saveLoadData" rows="5" cols="60" placeholder="ã“ã“ã«ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã¯ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚" style="display: block; margin-top: 1em;"></textarea>
  <p style="font-size: 0.8em; color: gray;">
    â€»ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¯ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚ä¸Šè¨˜ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚<br>
    ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã¯ã€ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šè¨˜ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘ã¦ã‹ã‚‰ã€Œãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
  </p>
</div>

<details>
  <summary>Ver.4.6.6ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ</summary><p>
    <div style="margin-top: 1em; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9;">
é‡è¦ï¼ã€€æ›´æ–°ä»¥å‰ã‹ã‚‰ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ãŸäººã¯ä¸€åº¦æ‰‹å‹•ã§ã‚»ãƒ¼ãƒ–ã€ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼</br>
[è¦‹ãŸç›®]è¨ˆç”»ã‚­ãƒ¥ãƒ¼ã®å¯è¦–åŒ–ã€æ’¤å›ã‚’å¯èƒ½ã«ã™ã‚‹</br>
[è¦‹ãŸç›®]é™¸åœ°é¢ç©ã®å¯è¦–åŒ–(ç›®å®‰)</br>
[æ©Ÿèƒ½]ã€Œã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å…ˆé ­ã«æˆ»ã•ãªã„ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¿½åŠ </br>
[æ©Ÿèƒ½]è¨ˆç”»ã‚­ãƒ¥ãƒ¼ã«æœ€å¤§20ä»¶ä¿å­˜å¯èƒ½ã«ãªã‚‹(å®Ÿè¡Œæ•°ã¯å¤‰ã‚ã‚‰ãš)</br>
[æ©Ÿèƒ½]ã€Œé…å»¶è¡Œå‹•ã€è¨ˆç”»ã®å®Ÿè£…</br>
[ä¿®æ­£]è¾²å ´/å·¥å ´å»ºè¨­ã¨è¨­å‚™å¼·åŒ–ã‚’åŒæ™‚ã«è¡Œã†ã¨ãã«å¤±æ•—ã—ãªããªã‚‹</br>
[ä¿®æ­£]æ•´åœ°ã¨é˜²è¡›æ–½è¨­å»ºè¨­ã‚’åŒæ™‚ã«è¡Œã†ã¨ãã«å¤±æ•—ã—ãªããªã‚‹</br>
[è¿½åŠ ]æµ·ã‚’æ˜å‰Šã™ã‚‹ã¨ä½ç¢ºç‡ã§æ²¹ç”°ãŒç™ºæ˜ã•ã‚Œã€åå…¥ãŒå¢—ãˆã‚‹</br>
[è¿½åŠ ]æ˜å‰Šæ™‚ã€ç™ºæ˜ã®ç¢ºç‡ã‚’æŒ‡å®šã—ã¦æ²¹ç”°ç™ºæ˜ç‡ã‚’ä¸Šã’ã‚‰ã‚Œã‚‹</br>
[è¿½åŠ ]æ²¹ç”°ã«ã‚‚è¨­å‚™å¼·åŒ–ãŒå¯èƒ½ã«ãªã‚‹(æ¯æ¸‡ç‡ã¯ä¸ŠãŒã‚‹)</br>
[è¿½åŠ ]ç½å®³ã€Œéš†èµ·ã€ï¼šå±±ã®ç™ºç”Ÿ</br>
[è¿½åŠ ]ç½å®³ã€Œå™´ç«ã€ï¼šä¸Šç´šãªå³¶ã¯ä¸€å®šæœŸé–“ã€€é£Ÿæ–™ç”£å‡ºåœæ­¢, äººå£å¢—åŠ åœæ­¢</br>
[è¿½åŠ ]ç½å®³ã€ŒçµŒæ¸ˆå±æ©Ÿã€ï¼šä¸Šç´šãªå³¶ã¯ä¸€å®šæœŸé–“ã€€ä¸€éƒ¨è³‡é‡‘å‡çµ, è³‡é‡‘ç®—å‡ºæ¿€æ¸›, ç¶­æŒè²»æ¿€å¢—</br>
[è¿½åŠ ]ç½å®³ã€Œåœ°éœ‡/æ´¥æ³¢ã€ï¼šä¸Šç´šãªå³¶ã§ç¨€ã«ç™ºç”Ÿã—ã€åºƒç¯„å›²ãŒç ´å£Šã•ã‚Œã‚‹</br>
    </div>
</p></details>
<p>é™¸åœ°é¢ç©: <span id="landArea">0</span>KmÂ² | ç ²æ’ƒå¯èƒ½æ•°ä¸Šé™: <span id="gunCount">0</span>å› | å®Ÿç¸¾Pt: <span id="achievementPoints">0</span>Pt</br>è³‡é‡‘: <span id="money">1000</span>G | é£Ÿæ–™: <span id="food">500</span> | äººå£: <span id="population">0</span>äºº | ã‚¿ãƒ¼ãƒ³: <span id="turn">0</span> | å³¶ã®åå‰: <span id="currentIslandName"></span></p>
<div>
    <label for="otherIslandActionInput">ä»–å³¶ã®è¡Œå‹•:</label>
    <input type="text" id="otherIslandActionInput" style="width: 400px; margin-bottom: 5px;" placeholder="ã“ã“ã«ä»–å³¶ã‹ã‚‰ã®è¡Œå‹•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
</div>
<div>
    <label for="actionForOtherIslandOutput">ä»–å³¶ã¸ã®è¡Œå‹•:</label>
    <input type="text" id="actionForOtherIslandOutput" style="width: 400px; margin-bottom: 5px;" readonly>
</div>
<div style="margin-top: 2px;">
    <input type="checkbox" id="keepOptionSelected">
    <label for="keepOptionSelected">ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å…ˆé ­ã«æˆ»ã•ãªã„</label>
</div>
<button onclick="nextTurn()">â–¶ ã‚¿ãƒ¼ãƒ³ã‚’é€²ã‚ã‚‹</button>
<br>
<select id="actionSelect" onchange="updateConfirmButton()">
  <option value="">è¨ˆç”»ä¸€è¦§</option>
  <option value="buildFarm" data-myisland="true">è¾²å ´å»ºè¨­ (100G)</option>
  <option value="buildFactory" data-myisland="true">å·¥å ´å»ºè¨­ (100G)</option>
  <option value="enhanceFacility" data-myisland="true">è¨­å‚™å¼·åŒ– (10000G)</option>
  <option value="buildPort" data-myisland="true">æ¸¯å»ºè¨­ (3000G)</option>
  <option value="buildGun" data-myisland="true">ç ²å°å»ºè¨­ (1200G)</option>
  <option value="buildDefenseFacility" data-myisland="true">é˜²è¡›æ–½è¨­å»ºè¨­ (5000G)</option>
  <option value="flatten" data-myisland="true">æ•´åœ° (20G)</option>
  <option value="landfill" data-myisland="true">åŸ‹ã‚ç«‹ã¦ (600G)</option>
  <option value="dig" data-myisland="true">æ˜å‰Š (300G)</option>
  <option value="cutForest" data-myisland="true">ä¼æ¡ (ç„¡æ–™)</option>
  <option value="plantForest" data-myisland="true">æ¤æ— (200G)</option>
  <option value="exportFood" data-myisland="true">é£Ÿæ–™è¼¸å‡º (é£Ÿæ–™20)</option>
  <option value="bombard" data-anyisland="true">ç ²æ’ƒ (120G)</option>
  <option value="spreadBombard" data-anyisland="true">æ‹¡æ•£å¼¾ç ²æ’ƒ (500G)</option>
  <option value="ppBombard" data-anyisland="true">PPå¼¾ç ²æ’ƒ (10000000G)</option>
  <option value="selfDestructMilitaryFacility" data-myisland="true">è»äº‹æ–½è¨­è‡ªçˆ† (ç„¡æ–™)</option>
  <option value="goToOtherIsland" data-myisland="true">ä»–ã®å³¶ã«è¡Œã</option>
  <option value="returnToMyIsland" data-anyisland="true">è‡ªå³¶ã«æˆ»ã‚‹</option>
  <option value="delayAction" data-myisland="true">é…å»¶è¡Œå‹•</option>
  <option value="buildWarship" data-myisland="true">è»è‰¦å»ºé€ </option>
  <option value="warshipTool" data-myisland="true">è»è‰¦ãƒ„ãƒ¼ãƒ«</option>
  <option value="buildMonument" data-myisland="true">çŸ³ç¢‘å»ºè¨­ (500000000G)</option>
  <option value="upgradeMonument" data-myisland="true">çŸ³ç¢‘å¼·åŒ– (500000000G)</option>
  <option value="sellMonument" data-myisland="true">çŸ³ç¢‘å£²å´ (ç„¡æ–™)</option>
  <option value="initializeIsland" data-myisland="true">å³¶ã®åˆæœŸåŒ–</option>
</select><select id="warshipSubSelect" onchange="updateConfirmButton()" style="width: 140px; display: none;">
  <option value="">è»è‰¦ãƒ„ãƒ¼ãƒ«ã‚’é¸æŠ</option>
  <option value="refuelWarship" data-myisland="true">ç‡ƒæ–™è£œçµ¦</option>
  <option value="resupplyWarshipAmmo" data-myisland="true">å¼¾è–¬è£œçµ¦</option>
  <option value="repairWarship" data-myisland="true">è»è‰¦ä¿®ç†</option>
  <option value="enhanceWarship" data-myisland="true">è»è‰¦å¢—å¼·</option>
  <option value="decommissionWarship" data-myisland="true">è»è‰¦é™¤ç±</option>
  <option value="dispatchWarship" data-myisland="true">è»è‰¦æ´¾é£</option>
  <option value="requestWarshipReturn" data-myisland="true">è»è‰¦å¸°é‚„è¦è«‹</option>
</select>
<input type="number" id="exportAmount" placeholder="è¼¸å‡ºæ•°" min="1" style="width: 60px; display: none;">
<input type="number" id="bombardCount" placeholder="æ”»æ’ƒæ•°" min="1" style="width: 60px; display: none;">
<input type="number" id="refuelAmount" placeholder="è£œçµ¦æ•°" min="1" style="width: 60px; display: none;">
<input type="number" id="resupplyAmmoAmount" placeholder="è£œçµ¦æ•°" min="1" style="width: 60px; display: none;">
<input type="number" id="repairAmount" placeholder="å›å¾©è€ä¹…å€¤" min="1" style="width: 90px; display: none;">
<input type="number" id="oilDrillFactor" placeholder="ç™ºæ˜ç‡(ä»»æ„)" min="1" max="10" value="" style="width: 90px; display: none;">
<input type="text" id="touristCodeInput" placeholder="è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="width: 250px; display: none;">
<div id="warshipBuildInputs">
    <h3>è»è‰¦å»ºé€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
    <div>
        <label for="warshipName">è‰¦å:</label>
        <input type="text" id="warshipName" maxlength="15" value="ç„¡éŠ˜è‰¦">
    </div>
    <div>
        <label for="warshipDurability">è€ä¹…åº¦:</label>
        <input type="number" id="warshipDurability" min="2" max="15" value="2"> (2ï½15, 1ã‚ãŸã‚Š10,000,000G)
    </div>
    <div>
        <label for="warshipMainGun">ä¸»ç ²:</label>
        <input type="number" id="warshipMainGun" min="1" max="5" value="1"> (1ï½5, 1ã‚ãŸã‚Š12,000,000G)
    </div>
    <div>
        <label for="warshipTorpedo">é­šé›·:</label>
        <input type="number" id="warshipTorpedo" min="0" max="3" value="0"> (0ï½3, 1ã‚ãŸã‚Š10,000,000G)
    </div>
    <div>
        <label for="warshipAntiAir">å¯¾ç©ºç ²:</label>
        <input type="number" id="warshipAntiAir" min="1" max="6" value="1"> (1ï½6, 1ã‚ãŸã‚Š5,000,000G)
    </div>
    <div>
        <label for="warshipAmmo">å¼¾è–¬åº«:</label>
        <input type="number" id="warshipAmmo" min="10" max="500" value="10"> (10ï½500, 1ã‚ãŸã‚Š100,000G)
    </div>
    <div>
        <label for="warshipRecon">åµå¯Ÿæ©Ÿ:</label>
        <input type="number" id="warshipRecon" min="0" max="2" value="0"> (0ï½2, 1ã‚ãŸã‚Š12,500,000G)
    </div>
    <div>
        <label for="warshipAccuracy">å°„æ’ƒç²¾åº¦å‘ä¸Š:</label>
        <input type="number" id="warshipAccuracy" min="0" max="2" value="0"> (0ï½2, 1ã‚ãŸã‚Š50,000,000G)
    </div>
</div>
<button onclick="confirmAction()" id="confirmBtn" disabled>æ±ºå®š</button>
<span id="tileInfo"></span>
<div id="gameContainer" style="display: flex; gap: 5px;">
    <table id="map"></table>
    <div id="actionQueueDisplay" style="font-size: 0.7em;margin-top: 1em; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9;">
      <h4>è¨ˆç”»ã‚­ãƒ¥ãƒ¼</h4><ul id="actionQueueList" style="list-style-type: none; padding: 0;"></ul>è¨­å®šã—ãŸè¨ˆç”»ã¯ã‚¯ãƒªãƒƒã‚¯ã§æ’¤å›å¯èƒ½ã§ã™ã€‚
    </div>
</div>
<div id="log" style="margin-top:1em;"></div>
<script>
let monster = null;
const MONSTER_TYPES = {
  1: { name: 'æ€ªç£ã‚·ãƒã‚ªãƒ­ã‚·', minHP: 1, maxHP: 1, ability: null, condition: (pop) => pop >= 60000 },
  2: { name: 'æ€ªç£ãƒ´ã‚©ãƒ«ã‚«ã‚¬ãƒ­ã‚¹', minHP: 2, maxHP: 4, ability: 'destroyArea', condition: (pop) => pop >= 120000 },
  3: { name: 'æ€ªç£ã‚¢ã‚¨ãƒ­ã‚¬ãƒ­ã‚¹', minHP: 3, maxHP: 3, ability: 'multiMove', condition: (pop) => pop >= 120000 },
  4: { name: 'æ€ªç£ãƒ†ãƒ©ã‚¬ãƒ­ã‚¹', minHP: 5, maxHP: 5, ability: 'landfillSea', condition: (pop) => pop >= 150000 },
  5: { name: 'æ€ªç£ã‚¢ã‚¯ã‚¢ã‚¬ãƒ­ã‚¹', minHP: 3, maxHP: 5, ability: 'createSea', condition: (pop) => pop >= 150000 }
};
  const SIZE = 16;
  let money = 2500;
  let food = 1000;
  let population = 0;
  let turn = 0;
  let achievementPoints = 0;
  let tutorialMissions = {
      '01': false, '02': false, '03': false, '04': false, '05': false, '06': false, '07': false, '08': false
  };
  let map = [];
  let selectedX = null, selectedY = null;
  let actionQueue = [];
  let islandName = "MyIsland";
  let warships = []; // è»è‰¦ã®é…åˆ—ã‚’è¿½åŠ 
  let economicCrisisTurns = 0; // çµŒæ¸ˆå±æ©Ÿã®æ®‹ã‚Šã‚¿ãƒ¼ãƒ³æ•°
  let frozenMoney = 0; // çµŒæ¸ˆå±æ©Ÿã«ã‚ˆã‚‹å‡çµè³‡é‡‘
  let volcanoTurns = 0; // ç«å±±ã®å™´ç« æ®‹ã‚Šã‚¿ãƒ¼ãƒ³æ•°

  // è»è‰¦ã®è‰²å¤‰åŒ–æ¡ä»¶
  const WARSHIP_CAPS = {
      maxDurability: 30,
      mainGun: 15,
      antiAir: 35,
      maxFuel: 1000,
      maxAmmo: 1200
  };
function factorial(n) {
    if (n < 0) return NaN;
    if (n === 0 || n === 1) return 1;
    let result = 1;
    for (let i = 2; i <= n; i++) {
        result *= i;
    }
    return result;
}
/**
 * è»è‰¦ãŒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸéš›ã«ã€ç«ç½ã¾ãŸã¯å¼¾è–¬åº«ã®ç™ºç«ã‚’åˆ¤å®šã™ã‚‹
 * @param {object} warship ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸè»è‰¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param {number} damage å®Ÿéš›ã«å—ã‘ãŸãƒ€ãƒ¡ãƒ¼ã‚¸é‡ (ä»Šå›ã¯ä½¿ç”¨ã—ãªã„ãŒæ±ç”¨æ€§ã®ãŸã‚ã«æ®‹ã™)
 */
function checkAbnormalityOnDamage(warship, damage) {
    // æ—¢ã«ç•°å¸¸çŠ¶æ…‹ã‹ã€æ²ˆæ²¡ã—ã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if (warship.currentDurability <= 0 || warship.abnormality !== null) {
        return; 
    }
    let newAbnormality = null;
    if (warship.currentAmmo >= 1000 && Math.random() < 0.30) {
        newAbnormality = 'ammoFire'; 
    }
    if (newAbnormality === null && Math.random() < 0.10) {
        newAbnormality = 'fire';
    }
        if (newAbnormality !== null) {
        warship.abnormality = newAbnormality;
        if (newAbnormality === 'fire') {
            logAction(`è»è‰¦ ${warship.name} ã«ç«ç½ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼`);
        } else if (newAbnormality === 'ammoFire') {
            logAction(`è»è‰¦ ${warship.name} ã®å¼¾è–¬åº«ãŒç™ºç«ã—ã¾ã—ãŸï¼`);
        }
    }
}
/**
 * ç ²æ’ƒãŒå‘½ä¸­ã—ãŸéš›ã«ã€é€šä¿¡éšœå®³ã¾ãŸã¯æµ¸æ°´ã‚’åˆ¤å®šã™ã‚‹
 * @param {object} target å‘½ä¸­ã—ãŸè»è‰¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function checkAbnormalityOnHit(target) {
    if (target.currentDurability <= 0 || target.abnormality !== null) {
        return;
    }
    
    let newAbnormality = null;
    if (target.currentDurability <= 50 && Math.random() < 0.05) {
        newAbnormality = 'flooding';
    }

    // 1. é€šä¿¡éšœå®³ã®åˆ¤å®š (å‘½ä¸­ã—ãŸéš›ã€1%ã®ç¢ºç‡)
    // è‡ªå³¶ã«ã„ã‚‹å ´åˆã¯ç™ºç”Ÿã—ãªã„ (isDispatchedãŒtrueã®æ™‚ã®ã¿ç™ºç”Ÿ)
    if (newAbnormality === null && target.isDispatched && Math.random() < 0.01) {
        newAbnormality = 'commFailure'; 
    }

    if (newAbnormality !== null) {
        target.abnormality = newAbnormality;
        if (newAbnormality === 'flooding') {
            logAction(`è»è‰¦ ${target.name} ã«æµ¸æ°´ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼`);
        } else if (newAbnormality === 'commFailure') {
            logAction(`è»è‰¦ ${target.name} ã«é€šä¿¡éšœå®³ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼`);
        }
    }
}
function getActionName(action, x, y, extraData) {
    let name = '';
    const actionNames = {
        buildFarm: 'è¾²å ´å»ºè¨­', buildFactory: 'å·¥å ´å»ºè¨­', enhanceFacility: 'è¨­å‚™å¼·åŒ–', buildPort: 'æ¸¯å»ºè¨­',
        buildGun: 'ç ²å°å»ºè¨­', buildDefenseFacility: 'é˜²è¡›æ–½è¨­å»ºè¨­', flatten: 'æ•´åœ°', landfill: 'åŸ‹ã‚ç«‹ã¦',
        dig: 'æ˜å‰Š', cutForest: 'ä¼æ¡', plantForest: 'æ¤æ—', exportFood: 'é£Ÿæ–™è¼¸å‡º',
        bombard: 'ç ²æ’ƒ', spreadBombard: 'æ‹¡æ•£å¼¾ç ²æ’ƒ', ppBombard: 'PPå¼¾ç ²æ’ƒ', selfDestructMilitaryFacility: 'è»äº‹æ–½è¨­è‡ªçˆ†',
        goToOtherIsland: 'ä»–ã®å³¶ã«è¡Œã', returnToMyIsland: 'è‡ªå³¶ã«æˆ»ã‚‹', buildWarship: 'è»è‰¦å»ºé€ ',
        refuelWarship: 'ç‡ƒæ–™è£œçµ¦', resupplyWarshipAmmo: 'å¼¾è–¬è£œçµ¦', repairWarship: 'è»è‰¦ä¿®ç†',
        enhanceWarship: 'è»è‰¦å¢—å¼·', decommissionWarship: 'è»è‰¦é™¤ç±', dispatchWarship: 'è»è‰¦æ´¾é£',
        requestWarshipReturn: 'è»è‰¦å¸°é‚„è¦è«‹', buildMonument: 'çŸ³ç¢‘å»ºè¨­', upgradeMonument: 'çŸ³ç¢‘å¼·åŒ–',
        sellMonument: 'çŸ³ç¢‘å£²å´', initializeIsland: 'å³¶ã®åˆæœŸåŒ–', delayAction: 'é…å»¶è¡Œå‹•' 
    };
    name = actionNames[action] || action;

    // è¨ˆç”»ã®è©³ç´°æƒ…å ±ã‚’åå‰ã«çµ„ã¿è¾¼ã‚€
    if (action === 'exportFood' && extraData && extraData.amount) {
        name += ` (${extraData.amount * 20} é£Ÿæ–™)`;
    } else if ((action === 'bombard' || action === 'spreadBombard' || action === 'ppBombard') && extraData && extraData.count) {
        name += ` (${extraData.count} ç™º)`;
    } else if (action === 'refuelWarship' && extraData && extraData.amount) {
        name += ` (${extraData.amount} ç‡ƒæ–™)`;
    } else if (action === 'resupplyWarshipAmmo' && extraData && extraData.amount) {
        name += ` (${extraData.amount} å¼¾è–¬)`;
    } else if (action === 'repairWarship' && extraData && extraData.amount) {
        name += ` (${extraData.amount} è€ä¹…å›å¾©)`;
    } else if (action === 'buildWarship' && extraData && extraData.name) {
        name += ` (${extraData.name})`;
    } else if ((action === 'dispatchWarship' || action === 'requestWarshipReturn') && extraData && extraData.name) {
        name += ` (${extraData.name})`;
    } else if (action === 'goToOtherIsland' && extraData && extraData.code) {
        name += ` (ã‚³ãƒ¼ãƒ‰: ${extraData.code.substring(0, 10)}...)`;
    } else if (action === 'dig' && extraData && extraData.oilFactor && extraData.oilFactor > 1) {
        let cost = 300;
        cost = cost = 300 * extraData.oilFactor ** 2;
    name += ` (äºˆç®—:${cost} ãƒ¬ãƒ™ãƒ«:${extraData.oilFactor})`;
    }
    
    // åº§æ¨™ã®è¡¨ç¤º
    let coord = (x !== null && y !== null) ? `(${x},${y})` : '';

    return { name, coord };
}

// è¨ˆç”»ã‚­ãƒ¥ãƒ¼ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function renderActionQueue() {
    const list = document.getElementById('actionQueueList');
    if (!list) return;
    list.innerHTML = '';
    const MAX_QUEUE_SIZE = 20; 
    for (let index = 0; index < MAX_QUEUE_SIZE; index++) {
        const listItem = document.createElement('li');
        const task = actionQueue[index]; // ã‚­ãƒ¥ãƒ¼ã‹ã‚‰è¨ˆç”»ã‚’å–å¾—
        // 2æ¡ã®ç•ªå·ã‚’å…ˆé ­ã«è¿½åŠ 
        const displayIndex = (index + 1).toString().padStart(2, '0');
        if (task) {
            // è¨ˆç”»ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
            const { name, coord } = getActionName(task.action, task.x, task.y, task);
            let classList = "action-link";
            if (index < 2) {
                classList += " next-action";
            }
            listItem.innerHTML = `
                ${displayIndex} 
                <span class="${classList}" onclick="cancelAction(${index})">
                    ${coord} ${name}
                </span>
            `;
        } else {
            listItem.innerHTML = `${displayIndex} è¨ˆç”»ç„¡ã—`;
        }       
        list.appendChild(listItem);
    }
}
// è¨ˆç”»ã‚’æ’¤å›ã™ã‚‹é–¢æ•°
window.cancelAction = function (index) {
    if (index >= 0 && index < actionQueue.length) {
        const actionToCancel = actionQueue[index];
        const { name, coord } = getActionName(actionToCancel.action, actionToCancel.x, actionToCancel.y, actionToCancel);
        actionQueue.splice(index, 1);
        logAction(`è¨ˆç”»ã€Œ${coord} ${name}ã€ã‚’æ’¤å›ã—ã¾ã—ãŸã€‚`);
        renderActionQueue();
        saveMyIslandState(); // å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
    }
}
function checkAndCompleteMission(missionId, pt, foodReward, moneyReward, checkFunc, logMessage) {
    if (!tutorialMissions[missionId] && checkFunc()) {
        tutorialMissions[missionId] = true;
        achievementPoints += pt;
        food += foodReward;
        money += moneyReward;
        logAction(`ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒŸãƒƒã‚·ãƒ§ãƒ³${missionId}ã€Œ${logMessage}ã€ã‚’é”æˆã—ã€${pt}Ptã€${moneyReward}Gã€${foodReward}é£Ÿæ–™ã‚’ç²å¾—ã—ã¾ã—ãŸï¼`);
        updateStatus();
        saveMyIslandState();
        return true;
    }
    return false;
}
  // ä¸Šé™åˆ°é”æ•°ã«å¿œã˜ã¦è»è‰¦åã®ã‚¯ãƒ©ã‚¹ã‚’è¿”ã™é–¢æ•°
  function getWarshipCapClass(ship) {
      let cappedCount = 0;
      if (ship.maxDurability >= WARSHIP_CAPS.maxDurability) cappedCount++;
      if (ship.mainGun >= WARSHIP_CAPS.mainGun) cappedCount++;
      if (ship.antiAir >= WARSHIP_CAPS.antiAir) cappedCount++;
      if (ship.maxFuel >= WARSHIP_CAPS.maxFuel) cappedCount++;
      if (ship.maxAmmo >= WARSHIP_CAPS.maxAmmo) cappedCount++;
      if (ship.exp === "NaN") cappedCount = 10;

      if (cappedCount === 2) return 'warship-name-cap-2';
      if (cappedCount === 3) return 'warship-name-cap-3';
      if (cappedCount === 4) return 'warship-name-cap-4';
      if (cappedCount === 5) return 'warship-name-cap-5';
      if (cappedCount === 10) return 'warship-sp';
      return ''; // ä¸Šé™åˆ°é”ãŒ2ã¤æœªæº€ã®å ´åˆã¯è‰²ã‚’ä»˜ã‘ãªã„
  }
let myIslandState = null; // è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°
let isViewingOtherIsland = false; // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

function randTerrain() {
  const r = Math.random();
  // æµ·ãŒç”Ÿæˆã•ã‚Œã‚‹ç¢ºç‡ã‚‚åŠ ãˆã‚‹
  if (r < 0.2) return 'sea'; // æµ·ã®ç¢ºç‡ã‚’èª¿æ•´
  else if (r < 0.5) return 'plain';
  else if (r < 0.7) return 'waste';
  else return 'forest';
}
function getGunCount() {
    let targetMap = map;
    // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹å ´åˆã€è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‹ã‚‰ç ²å°æ•°ã‚’å–å¾—ã™ã‚‹
    // ãŸã ã—ã€è‡ªå³¶çŠ¶æ…‹ãŒã¾ã ãªã„ï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰å ´åˆã¯ç ²å°ã¯0ã¨ã™ã‚‹
    if (isViewingOtherIsland && myIslandState && myIslandState.map) {
        targetMap = myIslandState.map;
    } else if (isViewingOtherIsland && !myIslandState) {
        return 0;
    }

    if (targetMap.length === 0) return 0;

    // mapã‚’èµ°æŸ»ã—ã¦ç ²å° (facility: 'gun') ã®æ•°ã‚’æ•°ãˆã‚‹
    let count = 0;
    targetMap.forEach(row => {
        row.forEach(tile => {
            if (tile.facility === 'gun') {
                count++;
            }
        });
    });
    return count;
}
function initMap() {
  map = Array.from({ length: SIZE }, (_, y) =>
    Array.from({ length: SIZE }, (_, x) => {
      // å‘¨å›²4ãƒã‚¹ã‚’æµ·ã«ã™ã‚‹
      if (x < 4 || y < 4 || x >= SIZE - 4 || y >= SIZE - 4) {
        return { terrain: 'sea', facility: null, pop: 0, enhanced: false };
      }
      // ãƒ©ãƒ³ãƒ€ãƒ ãªé™¸åœ°é…ç½®ï¼ˆæ£®ã€å¹³åœ°ã€è’åœ°ï¼‰ã¨æµ·
      const terrain = randTerrain();
      return { terrain, facility: null, pop: 0, enhanced: false };
    })
  );
  let placed = 0;
  // åˆæœŸä½å®…ã‚’2ã¤é…ç½®
  // å¹³åœ°ã‚’æ¢ã—ã€ã™ã§ã«æ–½è¨­ãŒãªã„å ´æ‰€ã«é…ç½®ã™ã‚‹
  const possibleHouseLocations = [];
  for (let y = 4; y < SIZE - 4; y++) {
    for (let x = 4; x < SIZE - 4; x++) {
      const tile = map[y][x];
      if (tile.terrain === 'plain' && !tile.facility) {
        possibleHouseLocations.push({ x, y });
      }
    }
  }

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«2ã¤é¸æŠ
  possibleHouseLocations.sort(() => Math.random() - 0.5);

  for (let i = 0; i < Math.min(2, possibleHouseLocations.length); i++) {
    const { x, y } = possibleHouseLocations[i];
    const tile = map[y][x];
    tile.facility = 'house';
    tile.pop = 25;
    population += 25;
    placed++;
  }
document.getElementById('islandNameInput').value = islandName; // UIã«åˆæœŸå€¤ã‚’åæ˜ 
    renderActionQueue();
}

function updateStatus() {
const moneyElement = document.getElementById('money');
  if (economicCrisisTurns > 0) {
      moneyElement.innerHTML = `${money} <span style="color: red;">(ä½¿ç”¨ä¸å¯${frozenMoney})</span>`;
  } else {
      moneyElement.textContent = money;
  }
  document.getElementById('food').textContent = food < 0 ? 0 : food;
  document.getElementById('population').textContent = population < 0 ? 0 : population;
  document.getElementById('turn').textContent = turn;
  document.getElementById('currentIslandName').textContent = islandName;
  document.getElementById('achievementPoints').textContent = achievementPoints; // ã“ã“ã§å€¤ã‚’åæ˜ 
  const guns = getGunCount();
  document.getElementById('gunCount').textContent = guns;
  let landMap = map; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç¾åœ¨ã®ãƒãƒƒãƒ—
  
  if (isViewingOtherIsland && myIslandState && myIslandState.map) {
      landMap = myIslandState.map;
  } else if (isViewingOtherIsland && !myIslandState) {
      landMap = []; // é¢ç© 0 æ‰±ã„
  } else if (!isViewingOtherIsland) {
      landMap = map;
  }
  let landTiles = 0;
  if (landMap && landMap.length > 0) {
      landMap.forEach(row => {
          row.forEach(tile => {
              if (tile.terrain !== 'sea') {
                  landTiles++;
              }
          });
      });
  }
  const landArea = landTiles * 10;
  document.getElementById('landArea').textContent = landArea;
  // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã¯è³‡é‡‘ã€é£Ÿæ–™ã€äººå£ã‚’éè¡¨ç¤ºã«ã™ã‚‹
  document.getElementById('money').style.visibility = isViewingOtherIsland ? 'hidden' : 'visible';
  document.getElementById('food').style.visibility = isViewingOtherIsland ? 'hidden' : 'visible';
  document.getElementById('population').style.visibility = isViewingOtherIsland ? 'hidden' : 'visible';
}

// confirmButtonã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
window.updateConfirmButton = function () {
  const actionSelect = document.getElementById('actionSelect');
  const warshipSubSelect = document.getElementById('warshipSubSelect');

  let action = actionSelect.value;
  if (action === 'warshipTool') {
      warshipSubSelect.style.display = 'inline-block';
      action = warshipSubSelect.value; 
  } else {
      warshipSubSelect.style.display = 'none';
      warshipSubSelect.value = ""; // ã‚µãƒ–ã‚»ãƒ¬ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
  }
  document.getElementById('confirmBtn').disabled = (action === "");
  document.getElementById('exportAmount').style.display = 'none';
  document.getElementById('bombardCount').style.display = 'none';
  document.getElementById('touristCodeInput').style.display = 'none';
  document.getElementById('warshipBuildInputs').style.display = 'none';
  document.getElementById('refuelAmount').style.display = 'none';
  document.getElementById('resupplyAmmoAmount').style.display = 'none';
  document.getElementById('repairAmount').style.display = 'none';
  document.getElementById('oilDrillFactor').style.display = 'none';
  const options = actionSelect.options;
  for (let i = 0; i < options.length; i++) {
      const option = options[i];
      if (option.value === "") continue;

      if (isViewingOtherIsland) {
          if (option.dataset.anyisland) {
              option.style.display = '';
          } else {
              option.style.display = 'none';
          }
      } else {
          if (option.dataset.myisland || option.dataset.anyisland) {
              option.style.display = '';
          } else {
              option.style.display = 'none';
          }
      }
  }
  if (action === 'exportFood') {
      document.getElementById('exportAmount').style.display = 'inline-block';
  } else if (action === 'bombard' || action === 'spreadBombard' || action === 'ppBombard') {
      document.getElementById('bombardCount').style.display = 'inline-block';
  } else if (action === 'goToOtherIsland' || action === 'dispatchWarship') {
      document.getElementById('touristCodeInput').style.display = 'inline-block';
  } else if (action === 'buildWarship') {
      document.getElementById('warshipBuildInputs').style.display = 'block';
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
      document.getElementById('warshipName').value = "ç„¡éŠ˜è‰¦";
      document.getElementById('warshipDurability').value = 2;
      document.getElementById('warshipMainGun').value = 1;
      document.getElementById('warshipTorpedo').value = 0;
      document.getElementById('warshipAntiAir').value = 1;
      document.getElementById('warshipAmmo').value = 10;
      document.getElementById('warshipRecon').value = 0;
      document.getElementById('warshipAccuracy').value = 0;
  } else if (action === 'refuelWarship') {
      document.getElementById('refuelAmount').style.display = 'inline-block';
  } else if (action === 'resupplyWarshipAmmo') {
      document.getElementById('resupplyAmmoAmount').style.display = 'inline-block';
  } else if (action === 'repairWarship') {
      document.getElementById('repairAmount').style.display = 'inline-block';
  } else if (action === 'dig') {
    document.getElementById('oilDrillFactor').style.display = 'inline-block';
  }
}
function renderMap() {
  const table = document.getElementById('map');
  table.innerHTML = '';
  for (let y = 0; y < SIZE; y++) {
    const row = document.createElement('tr');
    for (let x = 0; x < SIZE; x++) {
      const cell = document.createElement('td');
      const tile = map[y][x];

      // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã¯ç ²å°ã¨é˜²è¡›æ–½è¨­ã‚’æ£®ã«å½è£…
      const displayFacility = (isViewingOtherIsland && (tile.facility === 'gun' || tile.facility === 'defenseFacility' || tile.facility === 'Monument')) ? 'forest' : tile.facility;
      const displayTerrain = (isViewingOtherIsland && (tile.facility === 'gun' || tile.facility === 'defenseFacility' || tile.facility === 'Monument')) ? 'forest' : tile.terrain;

      cell.className = displayTerrain; // åœ°å½¢ã‚¯ãƒ©ã‚¹
      if (displayFacility) cell.classList.add(displayFacility); // æ–½è¨­ã‚¯ãƒ©ã‚¹

      // å¼·åŒ–æ–½è¨­ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      if (tile.enhanced) {
          if (tile.facility === 'farm') cell.classList.add('enhancedFarm');
          if (tile.facility === 'factory') cell.classList.add('enhancedFactory');
          if (tile.facility === 'oilRig') cell.classList.add('enhancedOilRig');
      }
      // è»è‰¦ã®è¡¨ç¤º
      const warshipAtTile = warships.find(ship => ship.x === x && ship.y === y);
      if (warshipAtTile && !isViewingOtherIsland) { // è‡ªåˆ†ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã®ã¿è»è‰¦ã‚’è¡¨ç¤º
          if (warshipAtTile.currentDurability <= 0) { // æ²ˆæ²¡ã—ã¦ã„ã‚‹å ´åˆ
              cell.classList.add('warship-wreckage');
              cell.textContent = 'x'; // æ®‹éª¸ã‚¢ã‚¤ã‚³ãƒ³
          } else {
              cell.classList.add('warship');
              if (warshipAtTile.isDispatched) {
                  cell.classList.add('warship-dispatched'); // æ´¾é£ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                  cell.textContent = 'â›¶'; // æ´¾é£ä¸­ã‚¢ã‚¤ã‚³ãƒ³
              } else {
                  cell.textContent = 'ğŸš¢';
              }
          }
      } else {
          cell.textContent = displayFacility === 'farm' ? 'ğŸŒ¾' :
                             displayFacility === 'house' ? 'ğŸ ' :
                             displayFacility === 'factory' ? 'ğŸ­' :
                             displayFacility === 'gun' ? 'ğŸ”«' :
                             displayFacility === 'port' ? 'âš“' :
                             displayFacility === 'Monument' ? 'ğŸ—¿' :
                             displayFacility === 'defenseFacility' ? 'ğŸ›¡ï¸' :
                             displayFacility === 'oilRig' ? 'ğŸ›¢ï¸' :'';
                             displayTerrain === 'mountain' ? 'â›°ï¸' : '';
      }

      // å¼·åŒ–æ–½è¨­ã®ã‚¢ã‚¤ã‚³ãƒ³ã¯ãã®ã¾ã¾
      if (tile.enhanced) {
          if (tile.facility === 'farm') cell.textContent = 'ğŸŒ¾';
          if (tile.facility === 'factory') cell.textContent = 'ğŸ­';
          if (tile.facility === 'oilRig') cell.textContent = 'ğŸ›¢ï¸';
      }

      if (selectedX === x && selectedY === y) cell.classList.add('selected');
      cell.onmouseover = () => showTileInfo(x, y);
      cell.onclick = () => selectTile(x, y);
      row.appendChild(cell);
      // â˜…å¤‰æ›´: monsters é…åˆ—ã‚’ãƒã‚§ãƒƒã‚¯
      const monsterAtTile = monsters.find(m => m.x === x && m.y === y);
      if (monsterAtTile) {
        cell.textContent = 'ğŸ‘¾';
      }
    }
    table.appendChild(row);
  }
}
function showTileInfo(x, y) {
  const tile = map[y][x];
  let info = ` (${x},${y}) åœ°å½¢: ${tile.terrain}`;
  if (tile.facility) {
    let facilityNameMap = {
        farm: 'è¾²å ´',
        house: 'ä½å®…',
        factory: 'å·¥å ´',
        gun: 'ç ²å°',
        port: 'æ¸¯',
        defenseFacility: 'é˜²è¡›æ–½è¨­',
        Monument: 'çŸ³ç¢‘',
        oilRig: 'æµ·åº•æ²¹ç”°'
    };


    let facilityName = facilityNameMap[tile.facility] || tile.facility;

    if (tile.enhanced) { // å¼·åŒ–æ–½è¨­ã®è¡¨ç¤ºå
        if (tile.facility === 'farm') facilityName = 'å¼·åŒ–è¾²å ´';
        if (tile.facility === 'factory') facilityName = 'å¼·åŒ–å·¥å ´';
        if (tile.facility === 'oilRig') facilityName = 'é«˜åŠ¹ç‡æµ·åº•æ²¹ç”°';
    }
    info += ` / å»ºç‰©: ${facilityName}`;
    if (tile.facility === 'house' && !isViewingOtherIsland) info += ` (äººå£: ${tile.pop})`; // ä»–ã®å³¶ã§ã¯äººå£è¡¨ç¤ºãªã—
      if (tile.facility === 'Monument' && !isViewingOtherIsland) {
         info += ` (Lv: ${tile.MonumentLevel})`;
    }
  }

  const warshipAtTile = warships.find(ship => ship.x === x && ship.y === y);
  if (warshipAtTile && !isViewingOtherIsland) {
      // çµŒé¨“å€¤è¡¨ç¤ºã‚’ä¿®æ­£
      const expDisplay = warshipAtTile.exp === "NaN" ? "NaN" : warshipAtTile.exp;
      const warshipCapClass = getWarshipCapClass(warshipAtTile);
const warshipNameDisplay = warshipCapClass ? `<span class="${warshipCapClass}">${warshipAtTile.name}</span>` : warshipAtTile.name;
info += ` / è»è‰¦: ${warshipNameDisplay} (æ¯æ¸¯: ${warshipAtTile.homePort}, EXP: ${expDisplay}, è€ä¹…: ${warshipAtTile.currentDurability}/${warshipAtTile.maxDurability}, å¼¾è–¬: ${warshipAtTile.currentAmmo}/${warshipAtTile.maxAmmo}, ç‡ƒæ–™: ${warshipAtTile.currentFuel}/${warshipAtTile.maxFuel}`;
      if (warshipAtTile.isDispatched) {
          info += `, æ´¾é£ä¸­`;
      }
      if (warshipAtTile.currentDurability <= 0) {
       info += `, æ®‹éª¸`;
      }
      info += `)`;
  }
  const monsterAtTile = monsters.find(m => m.x === x && m.y === y);
  if (monsterAtTile) {
      const typeInfo = MONSTER_TYPES[monsterAtTile.typeId] || { name: 'ä¸æ˜ãªæ€ªç£' };
      info += ` / <span style="color: red;">${typeInfo.name} (ä½“åŠ›: ${monsterAtTile.hp})</span>`;
  }
  document.getElementById('tileInfo').innerHTML = info;
}
function selectTile(x, y) {
  selectedX = x;
  selectedY = y;
  renderMap();
}

// logActioné–¢æ•°ã‚’ä¿®æ­£ã—ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åŸºã¥ã„ã¦è‰²ã‚’é©ç”¨
function logAction(msg) {
  const log = document.getElementById('log');
  const entry = document.createElement('div');
  entry.textContent = `[ã‚¿ãƒ¼ãƒ³${turn}] ${msg}`;
  if (msg.includes('å¤±æ•—') || msg.includes('å°é¢¨') || msg.includes('éš•çŸ³') || msg.includes('ä¸è¶³') || msg.includes('å»ƒå¢Ÿ') || msg.includes('å£Šæ»…') || msg.includes('è¸ã¿è’ã‚‰ã—ã¾ã—ãŸ') || msg.includes('æ€ªç£ãŒå‡ºç¾') || msg.includes('è‡ªçˆ†') || msg.includes('æ”»æ’ƒã•ã‚Œã¾ã—ãŸ') || msg.includes('ç ²æ’ƒ') || msg.includes('ç ´å£Šã•ã‚Œã¾ã—ãŸ') || msg.includes('æ’ƒæ²ˆ')|| msg.includes('æ¯æ¸‡')|| msg.includes('çµŒæ¸ˆå±æ©Ÿ')|| msg.includes('éš†èµ·')|| msg.includes('å™´ç«')|| msg.includes('æ´¥æ³¢')|| msg.includes('åœ°éœ‡')) {
    entry.classList.add('log-red');
  } else if (msg.includes('å»ºè¨­') || msg.includes('å½¢æˆ') || msg.includes('è¨ä¼') || msg.includes('åˆæœŸåŒ–') || msg.includes('å¼·åŒ–') || msg.includes('è£œçµ¦') || msg.includes('ç§»å‹•ã—ã¾ã—ãŸ') || msg.includes('æ´¾é£') || msg.includes('å¸°é‚„') || msg.includes('è¦è«‹') || msg.includes('ä¿®ç†')) { // ä¿®ç†ã‚’è¿½åŠ 
    entry.classList.add('log-cyan');
  }
  log.prepend(entry);
}

// è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function generateTouristCode() {
    const simplifiedMap = map.map(row => row.map(tile => {
        let touristTerrain = tile.terrain;
        let touristFacility = tile.facility;

            if (touristFacility === 'gun' || touristFacility === 'defenseFacility' || touristFacility === 'Monument') {
            touristTerrain = 'forest';
            touristFacility = null;
        }
        return { terrain: touristTerrain, facility: touristFacility };
    }));
    const touristData = {
        map: simplifiedMap,
        islandName: islandName,
        turn: turn
    };
    const jsonString = JSON.stringify(touristData);
    // æ–°ã—ã„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹å¼ (btoaã¨encodeURIComponentã‚’çµ„ã¿åˆã‚ã›ã‚‹)
    return btoa(encodeURIComponent(jsonString));
}

// è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function encodeWarshipData(warship) {
    const data = {
        homePort: warship.homePort,
        name: warship.name,
        exp: warship.exp,
        currentFuel: warship.currentFuel,
        maxFuel: warship.maxFuel,
        maxDurability: warship.maxDurability,
        currentDurability: warship.currentDurability,
        mainGun: warship.mainGun,
        torpedo: warship.torpedo,
        antiAir: warship.antiAir,
        maxAmmo: warship.maxAmmo,
        currentAmmo: warship.currentAmmo,
        reconnaissance: warship.reconnaissance,
        accuracyImprovement: warship.accuracyImprovement,
        isDispatched: warship.isDispatched,
        originalCost: warship.originalCost || 0, // è¿½åŠ 
        abnormality: warship.abnormality || 0
    };
    const jsonString = JSON.stringify(data);
    return btoa(encodeURIComponent(jsonString));
}

// ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
function decodeWarshipData(encodedData) {
    const jsonString = decodeURIComponent(atob(encodedData));
    const data = JSON.parse(jsonString);
    // äº’æ›æ€§ç¶­æŒã®ãŸã‚ã®åˆæœŸåŒ–
    if (data.isDispatched === undefined) data.isDispatched = false;
    if (data.maxFuel === undefined) data.maxFuel = 100;
    if (data.originalCost === undefined) data.originalCost = 0; // è¿½åŠ 
    return data;
}


// è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
function saveGame() {
    const gameState = {
        map: JSON.parse(JSON.stringify(map)),
        money: money,
        food: food,
        population: population,
        turn: turn,
        achievementPoints: achievementPoints,
        tutorialMissions: tutorialMissions,
        islandName: islandName,
        monster: null,
        monsters: JSON.parse(JSON.stringify(monsters)), // æ–°ã—ã„é…åˆ—ã‚’ä¿å­˜
        actionQueue: JSON.parse(JSON.stringify(actionQueue)),
        warships: JSON.parse(JSON.stringify(warships)) // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    };
    const jsonString = JSON.stringify(gameState);
    // æ–°ã—ã„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹å¼ (btoaã¨encodeURIComponentã‚’çµ„ã¿åˆã‚ã›ã‚‹)
    document.getElementById('saveLoadData').value = btoa(encodeURIComponent(jsonString));
    logAction("ã‚²ãƒ¼ãƒ ãŒã‚»ãƒ¼ãƒ–ã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
}

function loadGame() {
    const encodedData = document.getElementById('saveLoadData').value;
    if (!encodedData) {
        logAction("ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }
    try {
        // æ–°ã—ã„ãƒ‡ã‚³ãƒ¼ãƒ‰æ–¹å¼
        const jsonString = decodeURIComponent(atob(encodedData));
        const gameState = JSON.parse(jsonString);

        map = gameState.map;
        money = gameState.money;
        food = gameState.food;
        population = gameState.population;
        turn = gameState.turn;
        achievementPoints = gameState.achievementPoints || 0;
        tutorialMissions = gameState.tutorialMissions || { 
            '01': false, '02': false, '03': false, '04': false, '05': false, '06': false, '07': false, '08': false
        };
        islandName = gameState.islandName || "MyIsland";
        
        // â˜…å¤‰æ›´: æ—§ monster ãƒ‡ãƒ¼ã‚¿å‡¦ç†
        monsters = gameState.monsters || []; // æ–°ã—ã„å½¢å¼ã‚’å„ªå…ˆ
        if (gameState.monster && !gameState.monsters) { // æ—§å½¢å¼(monster)ãŒã‚ã‚Šã€æ–°å½¢å¼(monsters)ãŒãªã„
            const oldMonster = gameState.monster;
            // mapãƒ‡ãƒ¼ã‚¿(gameState.map)ã‚’ä½¿ã£ã¦åœ°å½¢ãƒã‚§ãƒƒã‚¯
            if (gameState.map[oldMonster.y] && gameState.map[oldMonster.y][oldMonster.x] && gameState.map[oldMonster.y][oldMonster.x].terrain !== 'sea') { // æµ·ã«ã„ãªã„å ´åˆ
                monsters.push({
                    x: oldMonster.x,
                    y: oldMonster.y,
                    typeId: 1, // ã‚·ãƒã‚ªãƒ­ã‚·
                    hp: 1
                });
                logAction("æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ€ªç£ã‚’ã€Œæ€ªç£ã‚·ãƒã‚ªãƒ­ã‚·ã€ã¨ã—ã¦å¼•ãç¶™ãã¾ã—ãŸã€‚");
            } else {
                logAction("æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ€ªç£ã¯æµ·ã«ã„ãŸãŸã‚ã€æ¶ˆæ»…ã—ã¾ã—ãŸã€‚");
            }
        }
        monster = null; // æ—§ monster å¤‰æ•°ã¯ä½¿ã‚ãªã„

        actionQueue = gameState.actionQueue || []; // ãƒ­ãƒ¼ãƒ‰æ™‚ã«actionQueueãŒãªã„å ´åˆã«å¯¾å¿œ
        warships = gameState.warships || []; // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰

        // éå»ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«enhancedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®ãŸã‚ã«åˆæœŸåŒ–
        map.forEach(row => row.forEach(tile => {
            if (tile.enhanced === undefined) {
                tile.enhanced = false;
            }
            if (tile.MonumentLevel === undefined) {
                tile.MonumentLevel = 0;
            }
        }));
        // isDispatchedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®åˆæœŸåŒ–
        warships.forEach(ship => {
            if (ship.isDispatched === undefined) {
                ship.isDispatched = false;
            }
            if (ship.maxFuel === undefined) { // æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
                ship.maxFuel = 100;
            }
                if (ship.isKenzouWarship === undefined) {
                    ship.isKenzouWarship = false;
                }
            if (ship.originalCost === undefined) { // æ–°è¦ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
                ship.originalCost = 0;
            }
            if (ship.abnormality === undefined) { 
                ship.abnormality = null; 
            }
        });

        document.getElementById('islandNameInput').value = islandName; // UIã«ãƒ­ãƒ¼ãƒ‰ã—ãŸåå‰ã‚’åæ˜ 
        isViewingOtherIsland = false; // ãƒ­ãƒ¼ãƒ‰æ™‚ã¯è‡ªåˆ†ã®å³¶ã«ã„ã‚‹
        saveMyIslandState(); // ãƒ­ãƒ¼ãƒ‰ã—ãŸçŠ¶æ…‹ã‚’è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã¨ã—ã¦ä¿å­˜
        logAction("ã‚²ãƒ¼ãƒ ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚");
        renderMap();
        updateStatus();
        document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        updateConfirmButton(); // UIã‚’æ›´æ–°
        renderActionQueue();
    } catch (e) {
        logAction("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒä¸æ­£ã§ã™ã€‚");
        console.error(e);
    }
}


// è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
function saveMyIslandState() {
    myIslandState = {
        map: JSON.parse(JSON.stringify(map)), // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
        money: money,
        food: food,
        population: population,
        turn: turn,
        achievementPoints: achievementPoints,
        tutorialMissions: tutorialMissions,
        islandName: islandName,
        monster: null,
        monsters: JSON.parse(JSON.stringify(monsters)),
        actionQueue: JSON.parse(JSON.stringify(actionQueue)),
        warships: JSON.parse(JSON.stringify(warships)),
        economicCrisisTurns: economicCrisisTurns,
        frozenMoney: frozenMoney,
        volcanoTurns: volcanoTurns
    };
    localStorage.setItem('myIslandState', JSON.stringify(myIslandState));
}

// è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰
function loadMyIslandState() {
    const storedState = localStorage.getItem('myIslandState');
    if (storedState) {
        myIslandState = JSON.parse(storedState);
    } else {
        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã‚„ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸçŠ¶æ…‹
        myIslandState = {
            map: [], // initMapã§ç”Ÿæˆã•ã‚Œã‚‹
            money: 2500,
            food: 1000,
            population: 0,
            turn: 0,
            achievementPoints: 0,
            tutorialMissions: {
            '01': false, '02': false, '03': false, '04': false, '05': false, '06': false, '07': false, '08': false
        },
            islandName: "MyIsland",
            monster: null,
            monsters: [],
            actionQueue: [],
            warships: [], // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
            economicCrisisTurns: 0,
            frozenMoney: 0,
            volcanoTurns: 0
        };
        initMap(); // åˆæœŸãƒãƒƒãƒ—ç”Ÿæˆ
        saveMyIslandState(); // åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
    }

    map = JSON.parse(JSON.stringify(myIslandState.map));
    money = myIslandState.money;
    food = myIslandState.food;
    population = myIslandState.population;
    turn = myIslandState.turn;
    achievementPoints= myIslandState.achievementPoints;
    tutorialMissions= myIslandState.tutorialMissions;
    islandName = myIslandState.islandName;
    monsters = myIslandState.monsters ? JSON.parse(JSON.stringify(myIslandState.monsters)) : []; // æ–°
    if (myIslandState.monster && monsters.length === 0) { // æ—§å½¢å¼ãŒã‚ã‚Šã€æ–°å½¢å¼(monsters)ãŒãªã„
        const oldMonster = myIslandState.monster;
        if (map[oldMonster.y] && map[oldMonster.y][oldMonster.x]) { // åº§æ¨™å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            const tile = map[oldMonster.y][oldMonster.x];
            if (tile.terrain !== 'sea') { // æµ·ã«ã„ãªã„å ´åˆ
                monsters.push({
                    x: oldMonster.x,
                    y: oldMonster.y,
                    typeId: 1, // ã‚·ãƒã‚ªãƒ­ã‚·
                    hp: 1
                });
                logAction("æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ€ªç£ã‚’ã€Œæ€ªç£ã‚·ãƒã‚ªãƒ­ã‚·ã€ã¨ã—ã¦å¼•ãç¶™ãã¾ã—ãŸã€‚");
            } else {
                logAction("æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ€ªç£ã¯æµ·ã«ã„ãŸãŸã‚ã€æ¶ˆæ»…ã—ã¾ã—ãŸã€‚");
            }
        }
    }
    monster = null; // æ—§å¤‰æ•°ã¯ã‚¯ãƒªã‚¢
    actionQueue = JSON.parse(JSON.stringify(myIslandState.actionQueue));
    warships = myIslandState.warships ? JSON.parse(JSON.stringify(myIslandState.warships)) : []; // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
    economicCrisisTurns = myIslandState.economicCrisisTurns || 0;
    frozenMoney = myIslandState.frozenMoney || 0;
    volcanoTurns = myIslandState.volcanoTurns || 0;
    // isDispatchedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®åˆæœŸåŒ–
    warships.forEach(ship => {
        if (ship.isDispatched === undefined) {
            ship.isDispatched = false;
        }
        if (ship.maxFuel === undefined) { // æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
            ship.maxFuel = 100;
        }
        if (ship.originalCost === undefined) { // æ–°è¦ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
            ship.originalCost = 0;
        }
    });

    // éå»ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«enhancedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®ãŸã‚ã«åˆæœŸåŒ–
    map.forEach(row => row.forEach(tile => {
        if (tile.enhanced === undefined) {
            tile.enhanced = false;
        }
        if (tile.MonumentLevel === undefined) {
            tile.MonumentLevel = 0;
        }
    }));


    isViewingOtherIsland = false;
    updateStatus();
    renderMap();
    logAction("è‡ªå³¶ã«æˆ»ã‚Šã¾ã—ãŸã€‚");
    document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    updateConfirmButton(); // UIã‚’æ›´æ–°
    renderActionQueue();
}


// ã‚²ãƒ¼ãƒ ã‚’åˆæœŸè¨­å®šã«æˆ»ã™é–¢æ•°
function resetGame() {
    money = 2500;
    food = 1000;
    population = 0;
    turn = 0;
    islandName = "MyIsland";
    monster = null;
    monsters = [];
    actionQueue = [];
    warships = []; // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
    economicCrisisTurns = 0;
    frozenMoney = 0;
    volcanoTurns = 0;
    selectedX = null;
    selectedY = null;

    document.getElementById('islandNameInput').value = islandName;
    document.getElementById('otherIslandActionInput').value = '';
    document.getElementById('actionForOtherIslandOutput').value = '';
    document.getElementById('touristCodeInput').value = '';

    initMap(); // ãƒãƒƒãƒ—ã‚’å†åˆæœŸåŒ–
    saveMyIslandState(); // åˆæœŸåŒ–ã•ã‚ŒãŸçŠ¶æ…‹ã‚’ä¿å­˜
    updateStatus();
    renderMap();
    isViewingOtherIsland = false; // åˆæœŸåŒ–æ™‚ã¯è‡ªåˆ†ã®å³¶ã«ã„ã‚‹
    document.getElementById('actionSelect').value = "";
    updateConfirmButton();
    renderActionQueue();
    logAction("å³¶ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚");
}

// ç‰¹å®šã®åº§æ¨™ãŒé˜²è¡›æ–½è¨­ã«ã‚ˆã£ã¦å®ˆã‚‰ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
// ä¿®æ­£ï¼šå®ˆã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®é˜²è¡›æ–½è¨­ã®ã‚¿ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹
function getProtectingDefenseFacility(targetX, targetY) {
    for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
            const tile = map[y][x];
            if (tile.facility === 'defenseFacility') {
                const dist = Math.max(Math.abs(x - targetX), Math.abs(y - targetY));
                if (dist <= 2) { // é˜²è¡›æ–½è¨­ã®å‘¨å›²2ãƒã‚¹
                    return tile; // é˜²è¡›æ–½è¨­ã®ã‚¿ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
                }
            }
        }
    }
    return null; // ä¿è­·ã•ã‚Œã¦ã„ãªã„å ´åˆã¯nullã‚’è¿”ã™
}

function handleWarshipAttacks() {
    const currentMap = map;
    const currentIslandName = islandName;
    const activeAttackingWarships = warships.filter(ship =>
        ship.currentDurability > 0 &&
        ship.currentAmmo > 0 &&
        ship.homePort !== currentIslandName
    );

    activeAttackingWarships.forEach(warship => {
        let attacksPerformed = 0;
        const totalAttacks = warship.mainGun + warship.torpedo;
        logAction(`${warship.name} (${warship.homePort}ç±) ãŒè‡ªå‹•æ”»æ’ƒã‚’é–‹å§‹ã—ã¾ã™ã€‚`);
        let attackRadius = 1; // 3x3 range (radius 1 from center means 1 tile in each direction, so 3x3 total)
        if (warship.reconnaissance === 1) attackRadius = 2; // 5x5 range
        if (warship.reconnaissance === 2) attackRadius = 3; // 7x7 range


        for (let i = 0; i < totalAttacks; i++) {
            if (warship.abnormality === 'fire') {
                logAction(`è»è‰¦ ${warship.name} ã¯ç«ç½ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ãŸã‚ã€æ”»æ’ƒã§ãã¾ã›ã‚“ã€‚`);
                break;
            }
            if (warship.currentAmmo <= 0) {
                logAction(`${warship.name} ã¯å¼¾è–¬ãŒãªããªã‚Šã¾ã—ãŸã€‚`);
                break;
            }
            let targetX, targetY;
            let validTargetFound = false;
            let attempts = 0;
            const maxAttempts = 100; // Prevent infinite loops

            while (!validTargetFound && attempts < maxAttempts) {
                targetX = warship.x + Math.floor(Math.random() * (2 * attackRadius + 1)) - attackRadius;
                targetY = warship.y + Math.floor(Math.random() * (2 * attackRadius + 1)) - attackRadius;

                // Check bounds and ensure it's not the warship's own location
                if (targetX >= 0 && targetX < SIZE && targetY >= 0 && targetY < SIZE &&
                    !(targetX === warship.x && targetY === warship.y)) {

                    const targetTile = currentMap[targetY][targetX];

                    // Exclude waste and sea unless it has a facility/monster/other warship
                    const isSeaOrWasteWithoutFacility =
                        (targetTile.terrain === 'sea' || targetTile.terrain === 'waste') &&
                        !targetTile.facility &&
                        !(monster && monster.x === targetX && monster.y === targetY) &&
                        !(warships.find(ship => ship.x === targetX && ship.y === targetY && ship !== warship)); // Check for other warships
                    const targetWarship = warships.find(ship => ship.x === targetX && ship.y === targetY && ship !== warship);
                    const isTargetSameHomeportWarship = targetWarship && (targetWarship.homePort === warship.homePort);
                    const isWreckage = targetWarship && targetWarship.currentDurability <= 0;
                    if (!isSeaOrWasteWithoutFacility && !isTargetSameHomeportWarship && !isWreckage && targetTile.terrain !== 'mountain') {
                        validTargetFound = true;
                    }
                }
                attempts++;
            }

            if (!validTargetFound) {
                continue; // Skip this attack
            }

            const targetTile = currentMap[targetY][targetX];
            let hitChance = 0.10; // Base 10%
            if (warship.accuracyImprovement === 1) {
                hitChance = 0.15;
            } else if (warship.accuracyImprovement === 2) {
                hitChance = 0.22;
            }
            let protectingDefenseFacility = null;
            if (warship.accuracyImprovement !== 1) {
                protectingDefenseFacility = getProtectingDefenseFacility(targetX, targetY);
                if (protectingDefenseFacility) {
                    hitChance *= 0.5; // Halve hit chance if protected by a defense facility
                    logAction(`é˜²è¡›æ–½è¨­ã®å¹²æ¸‰ã«ã‚ˆã‚Šã€${warship.name} ã®æ”»æ’ƒç²¾åº¦ãŒä½ä¸‹ã—ã¾ã—ãŸã€‚`);
                }
            }


            if (Math.random() < hitChance) {
                logAction(`${warship.name} ã®æ”»æ’ƒãŒ (${targetX},${targetY}) ã«å‘½ä¸­ï¼`);
                warship.currentAmmo--;
                attacksPerformed++;

                let expGained = 0;
                let targetType = "ä¸æ˜ãªæ–½è¨­";
                const monsterHit = monsters.find(m => m.x === targetX && m.y === targetY);
                if (monsterHit) {
                    expGained += 1; // çµŒé¨“å€¤
                    targetType = MONSTER_TYPES[monsterHit.typeId].name;
                    monsterHit.hp -= 1; // ãƒ€ãƒ¡ãƒ¼ã‚¸
                    
                    if (monsterHit.hp <= 0) {
                        monsters = monsters.filter(m => m !== monsterHit); // é…åˆ—ã‹ã‚‰å‰Šé™¤
                        logAction(`${warship.name} ã¯ ${targetType} ã‚’è¨ä¼ã—ã€${expGained} EXPã‚’ç²å¾—ã—ã¾ã—ãŸï¼`);
                    } else {
                        logAction(`${warship.name} ã¯ ${targetType} ã«å‘½ä¸­ï¼ (æ®‹ã‚Šä½“åŠ›: ${monsterHit.hp})`);
                    }
                } else {
                    const otherWarshipAtTarget = warships.find(ship => ship.x === targetX && ship.y === targetY && ship !== warship && ship.homePort !== warship.homePort);
                    if (otherWarshipAtTarget) {
                        expGained += 1;
                        targetType = "æ•µè»è‰¦";
                        if (otherWarshipAtTarget.currentDurability <= 10) {
                        logAction(`${otherWarshipAtTarget.name}ã¯${warship.name}ã®ç ²æ’ƒãŒå‘½ä¸­ã—ã€é»’ç…™ã‚’å™´ãå‡ºã—ã¾ã—ãŸã€‚ æ®‹ã‚Šè€ä¹…: ${otherWarshipAtTarget.currentDurability}`);
                        }else if (otherWarshipAtTarget.currentDurability <= 25) {
                        logAction(`${otherWarshipAtTarget.name}ã¯${warship.name}ã®ç ²æ’ƒã‚’å—ã‘ã¾ã—ãŸãŒã€è£…ç”²ã«ã‚ˆã‚Šæå‚·ã¯åƒ…ã‹ã§ã—ãŸã€‚ æ®‹ã‚Šè€ä¹…: ${otherWarshipAtTarget.currentDurability}`);
                        }else if (otherWarshipAtTarget.currentDurability <= 80) {
                        logAction(`${otherWarshipAtTarget.name}ã¯${warship.name}ã®ç ²æ’ƒã‚’å—ã‘ã¾ã—ãŸãŒã€ã»ã¼ç„¡å‚·ã§ã—ãŸã€‚ æ®‹ã‚Šè€ä¹…: ${otherWarshipAtTarget.currentDurability}`);
                        }else{
                        logAction(`${otherWarshipAtTarget.name}ã¯${warship.name}ã®ç ²æ’ƒã‚’å—ã‘ã¾ã—ãŸãŒã€å®Œå…¨ã«å‹•ã˜ãªã„ã‚ˆã†ã§ã™ã€‚ æ®‹ã‚Šè€ä¹…: ${otherWarshipAtTarget.currentDurability}`);
                        }
                        checkAbnormalityOnHit(otherWarshipAtTarget);
                        otherWarshipAtTarget.currentDurability -= 1; // Reduce durability
                        if (otherWarshipAtTarget.currentDurability <= 0) {
                            otherWarshipAtTarget.fuel = 0; // æ®‹ã‚Šç‡ƒæ–™ã‚’0ã«
                            otherWarshipAtTarget.currentFuel = 0; // ç¾åœ¨ç‡ƒæ–™ã‚‚0ã«
                            otherWarshipAtTarget.ammo = 0; // æ®‹ã‚Šå¼¾è–¬ã‚’0ã«
                            otherWarshipAtTarget.currentAmmo = 0; // ç¾åœ¨å¼¾è–¬ã‚‚0ã«
                            logAction(`æ•µè»è‰¦ã€Œ${otherWarshipAtTarget.name}ã€ã‚’æ’ƒæ²ˆã—ã¾ã—ãŸï¼`);
                            // For simplicity, a destroyed warship remains as wreckage on the map. renderMap will show 'x'.
                        }
                    } else if (targetTile.facility === 'house') { // House hit
    expGained += Math.floor(targetTile.pop / 2500);
    targetType = "ä½å®…";
    logAction(`${warship.name} ã¯ä½å®… (${targetTile.pop}äºº) ã‚’æ”»æ’ƒã—ã€${expGained} EXPã‚’ç²å¾—ã—ã¾ã—ãŸï¼`);
    population -= targetTile.pop;
    if (population < 0) population = 0;
    targetTile.pop = 0; // Destroy population
    targetTile.facility = null; // Remove facility
    targetTile.terrain = 'waste'; // Turn into waste
    targetTile.enhanced = false; // Remove enhancement
    } else if(targetTile.Monument) {
                targetType = 'çŸ³ç¢‘';
                if (targetTile.MonumentLevel >= 2) {
                    targetTile.MonumentLevel -= 1; // ãƒ¬ãƒ™ãƒ«ã‚’1ä¸‹ã’ã‚‹
                    logAction(`${warship.name} ã®æ”»æ’ƒã«ã‚ˆã‚Šã€çŸ³ç¢‘ã®ãƒ¬ãƒ™ãƒ«ãŒ1ä½ä¸‹ã—ã¾ã—ãŸ (Lv${targetTile.MonumentLevel})ã€‚`);
                } else { // ãƒ¬ãƒ™ãƒ«1ã®å ´åˆ
                    logAction(`${warship.name} ã¯çŸ³ç¢‘ï¼ˆLv1ï¼‰ã‚’ç ´å£Šã—ã¾ã—ãŸã€‚`);
                    targetTile.facility = null;
                    targetTile.terrain = 'waste'; // è’ã‚Œåœ°ã«ãªã‚‹
                    targetTile.MonumentLevel = 0; // ãƒ¬ãƒ™ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                }
    } else if(targetTile.facility) {
                        // Hit another facility (gun, factory, farm, port, defenseFacility)
                        targetType = targetTile.facility;
                        targetTile.facility = null;
                        targetTile.terrain = 'waste'; // Turn into waste
                        targetTile.enhanced = false; // Remove enhancement
                    }else {
                        // Hit a terrain without facility (plain, forest)
                        targetType = targetTile.terrain;
                        targetTile.terrain = 'waste';
                    }
                }
if (warship.exp === "NaN") {
    return;
}
                warship.exp += expGained;
            } else {
                warship.currentAmmo--; // Still consume ammo on miss
                attacksPerformed++;
            }
        }
        if (attacksPerformed > 0) {
            logAction(`${warship.name} ã¯åˆè¨ˆ ${attacksPerformed} å›ã®æ”»æ’ƒã‚’è¡Œã„ã¾ã—ãŸã€‚`);
        }
    });
}

// confirmActioné–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©
window.confirmAction = function () {
    const actionSelect = document.getElementById('actionSelect');
    const warshipSubSelect = document.getElementById('warshipSubSelect');
    let action = document.getElementById('actionSelect').value;
    if (action === 'warshipTool') {
        action = warshipSubSelect.value;
    }
    if (action === "") {
        if (actionSelect.value === 'warshipTool') {
            logAction(`è»è‰¦ãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„`);
        }
        return;
    }
  const targetTileSelected = (selectedX !== null && selectedY !== null);
  const MAX_QUEUE_SIZE = 20;
    if (actionQueue.length >= MAX_QUEUE_SIZE) {
        logAction(`è¨ˆç”»ã‚­ãƒ¥ãƒ¼ãŒæº€æ¯ã§ã™ï¼ˆæœ€å¤§${MAX_QUEUE_SIZE}å€‹ï¼‰ã€‚`);
        return; // ã‚­ãƒ¥ãƒ¼ãŒæº€æ¯ãªã‚‰å‡¦ç†ã‚’ä¸­æ–­
    }
const keepOptionSelected = document.getElementById('keepOptionSelected').checked;
  if (isViewingOtherIsland) {
      if (action === 'bombard' || action === 'spreadBombard' || action === 'ppBombard') {
          if (!targetTileSelected) {
              logAction(`ç ²æ’ƒå¯¾è±¡ã®ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„`);
              return;
          }
          const count = parseInt(document.getElementById('bombardCount').value);
          if (isNaN(count) || count <= 0) {
              logAction(`ç ²æ’ƒã®æ•°ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“`);
              return;
          }
          const guns = getGunCount(); // è‡ªå³¶ã®ç ²å°æ•°ã‚’å–å¾—
              if (guns === 0) {
                logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç ²å°ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰`);
                return;
              }
              if (count > guns) {
                logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç ²æ’ƒæ•°ãŒä¿æœ‰ç ²å°æ•° (${guns}) ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼‰`);
                return;
              }
          // è¡Œå‹•å†…å®¹ã‚’åœ§ç¸®ãƒ»æš—å·åŒ–ã—ã¦ä»–å³¶ã¸ã®è¡Œå‹•ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å‡ºåŠ›
          const actionData = {
              type: action,
              x: selectedX,
              y: selectedY,
              count: count
          };
          // æ–°ã—ã„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹å¼ (btoaã¨encodeURIComponentã‚’çµ„ã¿åˆã‚ã›ã‚‹)
          const encodedAction = btoa(encodeURIComponent(JSON.stringify(actionData)));
          document.getElementById('actionForOtherIslandOutput').value = encodedAction;
          logAction(`ä»–å³¶ã¸ã®è¡Œå‹•ãŒã€Œä»–å³¶ã¸ã®è¡Œå‹•ã€æ¬„ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚`);
          document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
          updateConfirmButton();
          updateConfirmButton(); // UIã‚’æ›´æ–°
          return;
      } else if (action === 'returnToMyIsland') {
          loadMyIslandState(); // è‡ªåˆ†ã®å³¶ã«æˆ»ã‚‹
          document.getElementById('actionForOtherIslandOutput').value = generateTouristCode(); // è‡ªåˆ†ã®è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›
          return;
      } else {
          logAction(`ä»–ã®å³¶ã§ã¯ç ²æ’ƒç³»ã‚³ãƒãƒ³ãƒ‰ã‹ã€Œè‡ªå³¶ã«æˆ»ã‚‹ã€ã®ã¿å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚`);
          document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
          updateConfirmButton(); // UIã‚’æ›´æ–°
          return;
      }
  }

  if (!action) return;
  const requiresTileSelection = ['buildFarm', 'buildFactory', 'buildPort', 'buildGun', 'buildDefenseFacility', 'buildWarship', 'refuelWarship', 'resupplyWarshipAmmo', 'repairWarship', 'dispatchWarship', 'requestWarshipReturn', 'flatten', 'landfill', 'dig', 'cutForest', 'plantForest', 'enhanceFacility', 'selfDestructMilitaryFacility', 'bombard', 'spreadBombard', 'ppBombard'];
  if (requiresTileSelection.includes(action) && !targetTileSelected) {
    logAction(`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¯¾è±¡ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„`);
    return;
  }

  let tile = null;
  if (targetTileSelected) {
      tile = map[selectedY][selectedX];
  }


  if (action === 'exportFood') {
    const amount = parseInt(document.getElementById('exportAmount').value);
    if (!isNaN(amount) && amount > 0) {
      actionQueue.push({ action, amount, x: null, y: null });
      logAction(`é£Ÿæ–™ã‚’ ${amount * 20} è¼¸å‡ºã™ã‚‹è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸ`);
    } else {
      logAction(`é£Ÿæ–™è¼¸å‡ºã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè¼¸å‡ºæ•°ãŒæœªæŒ‡å®šã¾ãŸã¯ç„¡åŠ¹ï¼‰`);
    }
  } else if (action === 'bombard' || action === 'spreadBombard' || action === 'ppBombard') {
    const count = parseInt(document.getElementById('bombardCount').value);
    if (isNaN(count) || count <= 0) {
      logAction(`ç ²æ’ƒã®æ•°ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“`);
      return;
    }
    const guns = getGunCount();
    if (guns === 0) {
      logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç ²å°ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰`);
      return;
    }
    let cost = 0;
    if (action === 'bombard') cost = count * 120;
    else if (action === 'spreadBombard') cost = count * 500;
    else if (action === 'ppBombard') cost = count * 10000000; // PPå¼¾ã®ä¾¡æ ¼ã‚’æ›´æ–°

    if (money < cost) {
      logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³‡é‡‘ä¸è¶³ï¼‰`);
      return;
    }
    if (count > guns) { // ä¿æœ‰ã—ã¦ã„ã‚‹ç ²å°ã®æ•°ã¾ã§ã—ã‹ç ²æ’ƒã§ããªã„
      logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¿æœ‰ç ²å°æ•°ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼‰`);
      return;
    }
    actionQueue.push({ x: selectedX, y: selectedY, action, count });
    logAction(`(${selectedX},${selectedY}) ã« ${count}ç™ºã®${action === 'bombard' ? 'ç ²æ’ƒ' : action === 'spreadBombard' ? 'æ‹¡æ•£å¼¾ç ²æ’ƒ' : 'PPå¼¾ç ²æ’ƒ'}ã‚’è¨ˆç”»ã—ã¾ã—ãŸ`);
  } else if (action === 'selfDestructMilitaryFacility') { // åç§°å¤‰æ›´
    if (tile && (tile.facility === 'gun' || tile.facility === 'defenseFacility')) {
      actionQueue.push({ x: selectedX, y: selectedY, action });
      logAction(`(${selectedX},${selectedY}) ã®è»äº‹æ–½è¨­è‡ªçˆ†ã‚’è¨ˆç”»ã—ã¾ã—ãŸ`);
    } else {
      logAction(`(${selectedX},${selectedY}) ã«è»äº‹æ–½è¨­ãŒã‚ã‚Šã¾ã›ã‚“`);
    }
  } else if (action === 'goToOtherIsland') {
      const touristCode = document.getElementById('touristCodeInput').value;
      if (touristCode) {
          try {
              const jsonString = decodeURIComponent(atob(touristCode));
              const otherIslandData = JSON.parse(jsonString);

              saveMyIslandState(); // è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
              map = otherIslandData.map;
              islandName = otherIslandData.islandName;
              turn = otherIslandData.turn; // ä»–ã®å³¶ã®ã‚¿ãƒ¼ãƒ³æ•°ã«ä¸€æ™‚çš„ã«åˆã‚ã›ã‚‹
              money = 0; food = 0; population = 0; // ä»–ã®å³¶ã®æƒ…å ±ã¯é™å®šè¡¨ç¤º
              monster = null;
              isViewingOtherIsland = true;
              logAction(`ã€Œ${islandName}ã€ã«ç§»å‹•ã—ã¾ã—ãŸã€‚`);
              renderMap();
              updateStatus();
              document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
              updateConfirmButton(); // UIã‚’æ›´æ–°
          } catch (e) {
              logAction(`è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
              console.error(e);
          }
      } else {
          logAction(`è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
      }
  } else if (action === 'returnToMyIsland') {
      loadMyIslandState(); // è‡ªåˆ†ã®å³¶ã«æˆ»ã‚‹
      document.getElementById('actionForOtherIslandOutput').value = generateTouristCode(); // è‡ªåˆ†ã®è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›
  } else if (action === 'initializeIsland') { // æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†
if (confirm('æœ¬å½“ã«ã“ã®æ“ä½œã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ')) {
      resetGame();
} else {
logAction(`å³¶ã®åˆæœŸåŒ–ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚`);
}
  }else if (action === 'buildWarship') { // è»è‰¦å»ºé€ 
      if (!targetTileSelected) {
          logAction("è»è‰¦ã‚’å»ºé€ ã™ã‚‹æµ·åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      // æ¸¯ã«éš£æ¥ã™ã‚‹æµ·åŸŸã‹ãƒã‚§ãƒƒã‚¯
      let adjacentToPort = false;
      for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
              const nx = selectedX + dx;
              const ny = selectedY + dy;
              if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && (dx !== 0 || dy !== 0)) {
                  if (map[ny][nx].facility === 'port') {
                      adjacentToPort = true;
                      break;
                  }
              }
          }
          if (adjacentToPort) break;
      }
      if (!adjacentToPort) {
          logAction("è»è‰¦ã¯æ¸¯ã«éš£æ¥ã™ã‚‹æµ·åŸŸã«ã®ã¿å»ºé€ å¯èƒ½ã§ã™ã€‚");
          return;
      }
      if (tile.terrain !== 'sea' || tile.facility !== null) {
          logAction(`(${selectedX},${selectedY}) ã¯è»è‰¦ã‚’å»ºé€ ã§ãã‚‹æµ·åŸŸã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
          return;
      }
      // Check if a warship already exists at the selected tile
      const existingWarship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (existingWarship) {
          logAction(`(${selectedX},${selectedY}) ã«ã¯æ—¢ã«è»è‰¦ã€Œ${existingWarship.name}ã€ãŒå­˜åœ¨ã—ã¾ã™ã€‚`);
          return;
      }
      const name = document.getElementById('warshipName').value.trim();
      const durability = parseInt(document.getElementById('warshipDurability').value);
      const mainGun = parseInt(document.getElementById('warshipMainGun').value);
      const torpedo = parseInt(document.getElementById('warshipTorpedo').value);
      const antiAir = parseInt(document.getElementById('warshipAntiAir').value);
      const ammo = parseInt(document.getElementById('warshipAmmo').value);
      const recon = parseInt(document.getElementById('warshipRecon').value);
      const accuracy = parseInt(document.getElementById('warshipAccuracy').value);

      if (!name || name.length > 15) {
          logAction("è‰¦åã¯1æ–‡å­—ä»¥ä¸Š15æ–‡å­—ä»¥ä¸‹ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(durability) || durability < 2 || durability > 15) {
          logAction("è€ä¹…åº¦ã¯2ï½15ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(mainGun) || mainGun < 1 || mainGun > 5) {
          logAction("ä¸»ç ²ã¯1ï½5ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(torpedo) || torpedo < 0 || torpedo > 3) {
          logAction("é­šé›·ã¯0ï½3ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(antiAir) || antiAir < 1 || antiAir > 6) {
          logAction("å¯¾ç©ºç ²ã¯1ï½6ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(ammo) || ammo < 10 || ammo > 500) {
          logAction("å¼¾è–¬åº«ã¯10ï½500ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(recon) || recon < 0 || recon > 2) {
          logAction("åµå¯Ÿæ©Ÿã¯0ï½2ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(accuracy) || accuracy < 0 || accuracy > 2) {
          logAction("å°„æ’ƒç²¾åº¦å‘ä¸Šã¯0ï½2ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }

        const cost = (durability * 10000000) + (mainGun * 12000000) + (torpedo * 10000000) + (antiAir * 5000000) + (ammo * 100000) + (recon * 12500000) + (accuracy * 50000000);
        if (money < cost) {
            const needed = cost - money; // ä¸è¶³é‡‘é¡ã‚’è¨ˆç®—
            logAction(`è»è‰¦å»ºé€ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³‡é‡‘ä¸è¶³: ${needed}G ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼‰`); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿®æ­£
            return;
        }
      actionQueue.push({ x: selectedX, y: selectedY, action, warshipData: { name, durability, mainGun, torpedo, antiAir, ammo, recon, accuracy, originalCost: cost } }); // originalCostã‚’è¿½åŠ 
      logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ã€Œ${name}ã€ã®å»ºé€ ã‚’è¨ˆç”»ã—ã¾ã—ãŸ (è²»ç”¨: ${cost}G)`);
  } else if (action === 'refuelWarship') { // ç‡ƒæ–™è£œçµ¦
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (!warship) {
          logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (warship.isDispatched) {
          logAction(`æ´¾é£ä¸­ã®è»è‰¦ã«ã¯ç‡ƒæ–™è£œçµ¦ã§ãã¾ã›ã‚“ã€‚`);
          return;
      }
      const amount = parseInt(document.getElementById('refuelAmount').value);
      if (isNaN(amount) || amount <= 0) {
          logAction(`è£œçµ¦æ•°ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
          return;
      }
      const cost = amount * 500; // é£Ÿæ–™500
      if (food < cost) {
          logAction(`ç‡ƒæ–™è£œçµ¦ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé£Ÿæ–™ä¸è¶³: ${cost} å¿…è¦ï¼‰`);
          return;
      }
      actionQueue.push({ x: selectedX, y: selectedY, action, amount });
      logAction(`(${selectedX},${selectedY}) ã®è»è‰¦ã«ç‡ƒæ–™ ${amount} ã‚’è£œçµ¦ã™ã‚‹è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸ (é£Ÿæ–™ ${cost} æ¶ˆè²»)`);
  } else if (action === 'resupplyWarshipAmmo') { // å¼¾è–¬è£œçµ¦
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (!warship) {
          logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (warship.isDispatched) {
          logAction(`æ´¾é£ä¸­ã®è»è‰¦ã«ã¯å¼¾è–¬è£œçµ¦ã§ãã¾ã›ã‚“ã€‚`);
          return;
      }
      const amount = parseInt(document.getElementById('resupplyAmmoAmount').value);
      if (isNaN(amount) || amount <= 0) {
          logAction(`è£œçµ¦æ•°ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
          return;
      }
      const cost = amount * 20000; // 20000G
      if (money < cost) {
          logAction(`å¼¾è–¬è£œçµ¦ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³‡é‡‘ä¸è¶³: ${cost}G å¿…è¦ï¼‰`);
          return;
      }
      actionQueue.push({ x: selectedX, y: selectedY, action, amount });
      logAction(`(${selectedX},${selectedY}) ã®è»è‰¦ã«å¼¾è–¬ã‚’ ${amount} è£œçµ¦ã™ã‚‹è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸ (è³‡é‡‘ ${cost}G æ¶ˆè²»)`);
  }else if (action === 'repairWarship') {
    if (!targetTileSelected) {
        logAction(`ä¿®ç†å¯¾è±¡ã®è»è‰¦ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
        return;
    }
    const ship = warships.find(s => s.x === selectedX && s.y === selectedY);
    if (!ship) {
        logAction(`é¸æŠã—ãŸã‚¿ã‚¤ãƒ«ã«è»è‰¦ãŒã„ã¾ã›ã‚“ã€‚`);
        return;
    }
    // æ’ƒæ²ˆã•ã‚Œã¦ã„ã‚‹è»è‰¦ã¯ä¿®ç†ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
    if (ship.currentDurability <= 0) {
        logAction(`${ship.name} ã¯æ’ƒæ²ˆã•ã‚Œã¦ãŠã‚Šã€ä¿®ç†ã§ãã¾ã›ã‚“ã€‚`);
        return;
    }
    if (ship.isDispatched) {
        logAction(`${ship.name} ã¯æ´¾é£ä¸­ãªã®ã§ä¿®ç†ã§ãã¾ã›ã‚“ã€‚`);
        return;
    }
    const repairAmount = parseInt(document.getElementById('repairAmount').value);
    if (isNaN(repairAmount) || repairAmount <= 0) {
        logAction(`å›å¾©è€ä¹…å€¤ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
        return;
    }

    const costPerDurability = 500000; // è€ä¹…åº¦1å›å¾©ã‚ãŸã‚Šã®è²»ç”¨
    // å›å¾©å¯èƒ½ãªè€ä¹…å€¤ã‚’è¨ˆç®—
    const missingDurability = ship.maxDurability - ship.currentDurability;
    if (missingDurability <= 0) {
        logAction(`${ship.name} ã®è€ä¹…åº¦ã¯ã™ã§ã«æœ€å¤§ã§ã™ã€‚`);
        return;
    }
    const actualRepairAmount = Math.min(repairAmount, missingDurability);
    const actualCost = actualRepairAmount * costPerDurability;
    if (money < actualCost) {
        logAction(`è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ä¿®ç†ã«ã¯ ${actualCost}G å¿…è¦ã§ã™ã€‚`);
        return;
    }
            if (ship.abnormality === 'ammoFire') {
                // å¼¾è–¬åº«ã®ç™ºç«: 10ä»¥ä¸Šä¿®ç†ã§æ²»ã‚‹
                if (repairAmount >= 10) {
                    ship.abnormality = null;
                    logAction(`è»è‰¦ ${ship.name} ã¯è€ä¹…å€¤ã‚’${repairAmount}ä¿®ç†ã—ã€å¼¾è–¬åº«ã®ç«ç½ã¯é®ç«ã•ã‚Œã¾ã—ãŸï¼`);
                }
            } else if (ship.abnormality !== null) {
                // ç«ç½ã€æµ¸æ°´ã€é€šä¿¡éšœå®³: 1ä»¥ä¸Šä¿®ç†ã§æ²»ã‚‹
                ship.abnormality = null;
                logAction(`è»è‰¦ ${ship.name} ã¯è€ä¹…å€¤ã‚’${repairAmount}ä¿®ç†ã—ã€ç•°å¸¸çŠ¶æ…‹(${oldAbnormality})ãŒå¾©æ—§ã—ã¾ã—ãŸï¼`);
            }
    money -= actualCost;
    ship.currentDurability += actualRepairAmount;
    logAction(`${ship.name} ã‚’ ${actualRepairAmount} è€ä¹…å€¤åˆ†ä¿®ç†ã—ã¾ã—ãŸã€‚è²»ç”¨: ${actualCost}Gã€‚ç¾åœ¨ã®è€ä¹…åº¦: ${ship.currentDurability}/${ship.maxDurability}`);
    renderMap();
    updateStatus();
    saveMyIslandState();
}else if (action === 'dispatchWarship') { // è»è‰¦æ´¾é£
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (!warship) {
          logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (warship.isDispatched) {
          logAction(`ã“ã®è»è‰¦ã¯ã™ã§ã«æ´¾é£ä¸­ã§ã™ã€‚`);
          return;
      }
      const touristCode = document.getElementById('touristCodeInput').value;
      if (!touristCode) {
          logAction(`æ´¾é£å…ˆã®è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
          return;
      }
      let targetIslandName;
      try {
          const jsonString = decodeURIComponent(atob(touristCode));
          const otherIslandData = JSON.parse(jsonString);
          targetIslandName = otherIslandData.islandName;
      } catch (e) {
          logAction(`ç„¡åŠ¹ãªè¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚`);
          return;
      }
      if (targetIslandName === islandName) {
          logAction(`æ¯æ¸¯ã¨åŒã˜å³¶ã«ã¯è»è‰¦ã‚’æ´¾é£ã§ãã¾ã›ã‚“ã€‚`);
          return;
      }
      const encodedWarshipData = encodeWarshipData(warship);
      const dispatchData = {
          type: "warshipDispatch",
          warshipData: encodedWarshipData,
          destinationIslandName: targetIslandName,
          sourceIslandName: islandName // æ´¾é£å…ƒã‚’è¨˜éŒ²
      };
      const encodedDispatchAction = btoa(encodeURIComponent(JSON.stringify(dispatchData)));
      document.getElementById('actionForOtherIslandOutput').value = encodedDispatchAction;
      warship.isDispatched = true; // æ´¾é£çŠ¶æ…‹ã«ã™ã‚‹
      warship.currentFuel = 0; // æ´¾é£ä¸­ã¯ç‡ƒæ–™0
      warship.currentAmmo = 0; // æ´¾é£ä¸­ã¯å¼¾è–¬0
      logAction(`è»è‰¦ã€Œ${warship.name}ã€ã‚’ã€Œ${targetIslandName}ã€ã¸æ´¾é£ã™ã‚‹è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸã€‚`);
      logAction(`ä»–å³¶ã¸ã®è¡Œå‹•ãŒã€Œä»–å³¶ã¸ã®è¡Œå‹•ã€æ¬„ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚`);
  } else if (action === 'requestWarshipReturn') {
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (!warship) {
          logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (!warship.isDispatched) {
          logAction(`ã“ã®è»è‰¦ã¯æ´¾é£ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (warship.homePort !== islandName) {
          logAction(`ã“ã®è»è‰¦ã®æ¯æ¸¯ã¯${warship.homePort}ã§ã‚ã‚Šã€ã“ã®å³¶ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
          return;
      }
      const returnRequestData = {
          type: "warshipReturnRequest", // æ–°ã—ã„ã‚¿ã‚¤ãƒ—
          homePort: warship.homePort,
          name: warship.name // è¦è«‹ã™ã‚‹è»è‰¦ã‚’ç‰¹å®šã™ã‚‹æƒ…å ±
      };
      const encodedReturnRequestAction = btoa(encodeURIComponent(JSON.stringify(returnRequestData)));
      document.getElementById('actionForOtherIslandOutput').value = encodedReturnRequestAction;

      logAction(`è»è‰¦ã€Œ${warship.name}ã€ã®å¸°é‚„ã‚’è¦è«‹ã—ã¾ã—ãŸã€‚ä»–å³¶ã¸ã®è¡Œå‹•ãŒã€Œä»–å³¶ã¸ã®è¡Œå‹•ã€æ¬„ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚`);
      // ã“ã“ã§ã¯è»è‰¦ã®çŠ¶æ…‹ã¯å¤‰æ›´ã—ãªã„ï¼ˆç›¸æ‰‹å³¶ã‹ã‚‰ã®ç¢ºèªã‚’å¾…ã¤ï¼‰
  } else if (action === 'enhanceWarship') {
    if (!targetTileSelected) {
        logAction(`å¢—å¼·å¯¾è±¡ã®è»è‰¦ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
        return;
    }
    const ship = warships.find(s => s.x === selectedX && s.y === selectedY);
    if (!ship) {
        logAction(`é¸æŠã—ãŸã‚¿ã‚¤ãƒ«ã«è»è‰¦ãŒã„ã¾ã›ã‚“ã€‚`);
        return;
    }

    const expCost = 200;
    if (ship.exp < expCost) {
        logAction(`${ship.name} ã®çµŒé¨“å€¤ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ï¼ˆ${expCost}EXP å¿…è¦ï¼‰`);
        return;
    }

    ship.exp -= expCost; // çµŒé¨“å€¤ã‚’æ¶ˆè²»

    let buffMessage = '';
    const rand = Math.random() * 100; // 0ã‹ã‚‰99.99...ã®ä¹±æ•°

    // ãƒãƒ•ã®ç¢ºç‡ã¨åŠ¹æœã‚’å®šç¾©
    if (rand < 35) { // 35%
        ship.maxFuel += 5;
        ship.fuel = Math.min(ship.fuel, ship.maxFuel); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `ç‡ƒæ–™ä¸Šé™+5`;
    } else if (rand < 70) { // 35% + 35% = 70%
        ship.maxAmmo += 10;
        ship.ammo = Math.min(ship.ammo, ship.maxAmmo); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `å¼¾è–¬åº«ä¸Šé™+10`;
    } else if (rand < 81) { // 70% + 11% = 81%
        ship.antiAir += 1;
        buffMessage = `å¯¾ç©ºç ²+1`;
    } else if (rand < 91) { // 81% + 10% = 91%
        ship.maxFuel += 10;
        ship.fuel = Math.min(ship.fuel, ship.maxFuel); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `ç‡ƒæ–™ä¸Šé™+10`;
    } else if (rand < 95) { // 91% + 4% = 95%
        ship.maxDurability += 1;
        ship.currentDurability = Math.min(ship.currentDurability, ship.maxDurability); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `è€ä¹…ä¸Šé™+1`;
    } else if (rand < 99) { // 95% + 4% = 99%
        ship.mainGun += 1;
        buffMessage = `ä¸»ç ²+1`;
    } else if (rand < 99.5) { // 99% + 0.5% = 99.5%
        ship.maxAmmo += 100;
        ship.ammo = Math.min(ship.ammo, ship.maxAmmo); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `å¼¾è–¬åº«ä¸Šé™+100`;
    } else if (rand < 99.8) { // 99.5% + 0.3% = 99.8%
        ship.antiAir += 2;
        ship.maxDurability += 1;
        ship.currentDurability = Math.min(ship.currentDurability, ship.maxDurability);
        buffMessage = `å¯¾ç©º+2ï¼†è€ä¹…ä¸Šé™+1`;
    } else { // 99.8% + 0.2% = 100%
        ship.maxDurability += 3;
        ship.currentDurability = Math.min(ship.currentDurability, ship.maxDurability);
        ship.mainGun += 2;
        buffMessage = `è€ä¹…ä¸Šé™+3ï¼†ä¸»ç ²+2`;
    }
    logAction(`${ship.name} ã‚’å¢—å¼·ã—ã¾ã—ãŸï¼ ${buffMessage}ã‚’ç²å¾—ã€‚ç¾åœ¨ã®çµŒé¨“å€¤: ${ship.exp}`);
    renderMap();
    updateStatus();
    saveMyIslandState();
} else if (action === 'decommissionWarship') {
    if (!targetTileSelected) {
        logAction(`é™¤ç±å¯¾è±¡ã®è»è‰¦ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
        return;
    }
    const shipIndex = warships.findIndex(s => s.x === selectedX && s.y === selectedY);
    const ship = warships[shipIndex];

    if (!ship) {
        logAction(`é¸æŠã—ãŸã‚¿ã‚¤ãƒ«ã«è»è‰¦ãŒã„ã¾ã›ã‚“ã€‚`);
        return;
    }
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
    const confirmation = confirm(`${ship.name} ã‚’é™¤ç±ã—ã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
      if (warship.homePort !== islandName) {
          logAction(`ã“ã®è»è‰¦ã®æ¯æ¸¯ã¯${warship.homePort}ã§ã‚ã‚Šã€ã“ã®å³¶ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
          return;
}if (confirmation) {
        warships.splice(shipIndex, 1);
        money += 1000000; // 1,000,000Gã‚’ç²å¾—

        logAction(`${ship.name} ã‚’é™¤ç±ã—ã€1,000,000Gã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`);
        renderMap();
        updateStatus();
        saveMyIslandState();
    } else {
        logAction(`è»è‰¦ ${ship.name} ã®é™¤ç±ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚`);
    }
}else if (action === 'dig') {
    if (!targetTileSelected) { logAction(`æ˜å‰Šå¯¾è±¡ã®ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„`); return; }
    
    // æ²¹ç”°ç™ºæ˜ç‡ã®å…¥åŠ›å€¤ã‚’å–å¾— (ç©ºç™½ã¾ãŸã¯1ï½10)
    let factorInput = document.getElementById('oilDrillFactor').value;
    let factor = 0;
    
    if (factorInput !== "") {
        factor = parseInt(factorInput);
        if (isNaN(factor) || factor < 1 || factor > 10) {
            logAction(`æ²¹ç”°ç™ºæ˜ç‡ã«ç„¡åŠ¹ãªå€¤ãŒå…¥åŠ›ã•ã‚Œã¾ã—ãŸ (1ï½10 ã¾ãŸã¯ç©ºç™½)`);
            return;
        }
    }
    // factorãŒ0ï¼ˆç©ºç™½ï¼‰ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œï¼ˆfactor=1ã¨åŒã˜æ‰±ã„ï¼‰
    if (factor === 0) factor = 1;

    actionQueue.push({ action, x: selectedX, y: selectedY, oilFactor: factor }); // oilFactorã¨ã—ã¦ä¿å­˜
    logAction(`(${selectedX},${selectedY}) ã‚’æ˜å‰Šã™ã‚‹è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸ (ç™ºæ˜ç‡Lv:${factor})`);
}else {
actionQueue.push({ x: selectedX, y: selectedY, action, keepSelected: keepOptionSelected });
    logAction(`(${selectedX},${selectedY}) ã« ${action} ã‚’è¨ˆç”»ã—ã¾ã—ãŸ`);
  }
if (!keepOptionSelected) {
    document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
}
  renderActionQueue();
  updateConfirmButton();
}

// nextTurné–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©
window.nextTurn = function () {
turn++;
    warships.forEach(warship => {
        if (warship.currentDurability <= 0) return;
        if (warship.abnormality === 'commFailure' && !warship.isDispatched) {
            warship.abnormality = null;
            logAction(`è»è‰¦ ${warship.name} ã¯å¸°æ¸¯ã—ãŸãŸã‚ã€é€šä¿¡éšœå®³ãŒè‡ªå‹•å¾©æ—§ã—ã¾ã—ãŸã€‚`);
            // çŠ¶æ…‹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚ŒãŸã®ã§ã€ä»Šã‚¿ãƒ¼ãƒ³ã®ç•°å¸¸çŠ¶æ…‹åŠ¹æœã¯ã‚¹ã‚­ãƒƒãƒ—
            return; 
        }

        switch (warship.abnormality) {
            case 'fire':
                // åŠ¹æœ: 1ãƒ€ãƒ¡ãƒ¼ã‚¸
                warship.currentDurability -= 1;
                logAction(`è»è‰¦ ${warship.name} ã¯ç«ç½ã«ã‚ˆã‚Š1ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¾ã—ãŸã€‚æ®‹ã‚Šè€ä¹…: ${warship.currentDurability}`);
                // è‡ªå‹•å¾©æ—§: 25%ã®ç¢ºç‡
                if (Math.random() < 0.25) {
                    warship.abnormality = null;
                    logAction(`è»è‰¦ ${warship.name} ã®ç«ç½ãŒè‡ªå‹•å¾©æ—§ã—ã¾ã—ãŸã€‚`);
                }
                break;
            case 'flooding':
                // åŠ¹æœ: 1ãƒ€ãƒ¡ãƒ¼ã‚¸
                warship.currentDurability -= 1;
                logAction(`è»è‰¦ ${warship.name} ã¯æµ¸æ°´ã«ã‚ˆã‚Š1ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¾ã—ãŸã€‚æ®‹ã‚Šè€ä¹…: ${warship.currentDurability}`);
                // è‡ªå‹•å¾©æ—§: 8%ã®ç¢ºç‡
                if (Math.random() < 0.08) {
                    warship.abnormality = null;
                    logAction(`è»è‰¦ ${warship.name} ã®æµ¸æ°´ãŒè‡ªå‹•å¾©æ—§ã—ã¾ã—ãŸã€‚`);
                }
                break;
            case 'ammoFire':
                warship.currentDurability -= 3;
                warship.currentAmmo = Math.max(0, warship.currentAmmo - 50);
                logAction(`è»è‰¦ ${warship.name} ã¯å¼¾è–¬åº«ã®ç™ºç«ã«ã‚ˆã‚Š3ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã€å¼¾è–¬ã‚’50æ¶ˆè²»ã—ã¾ã—ãŸã€‚æ®‹ã‚Šè€ä¹…: ${warship.currentDurability}ã€æ®‹ã‚Šå¼¾è–¬: ${warship.currentAmmo}`);
                if (warship.currentAmmo === 0) {
                     warship.abnormality = null;
                     logAction(`è»è‰¦ ${warship.name} ã¯å¼¾è–¬ãŒå°½ããŸãŸã‚ã€å¼¾è–¬åº«ã®ç™ºç«ãŒåã¾ã‚Šã¾ã—ãŸã€‚`);
                }
                break;
            case 'commFailure':
                break;
        }
        if (warship.currentDurability <= 0 && warship.abnormality !== null) {
            warship.currentDurability = 0;
            warship.currentFuel = 0;
            warship.currentAmmo = 0;
            warship.abnormality = null;
            logAction(`è»è‰¦ ${warship.name} ã¯ç•°å¸¸çŠ¶æ…‹ã®é€²è¡Œã«ã‚ˆã‚Šæ’ƒæ²ˆã—ã¾ã—ãŸï¼`);
        }
    });
  const otherIslandActionCode = document.getElementById('otherIslandActionInput').value;
  document.getElementById('otherIslandActionInput').value = ''; // å‡¦ç†ã—ãŸã‚‰ã‚¯ãƒªã‚¢
  if (otherIslandActionCode) {
      try {
          const jsonString = decodeURIComponent(atob(otherIslandActionCode));
          const incomingAction = JSON.parse(jsonString);

          if ((incomingAction.type === 'bombard' || incomingAction.type === 'spreadBombard' || incomingAction.type === 'ppBombard') &&
              incomingAction.x !== undefined && incomingAction.y !== undefined && incomingAction.count !== undefined) {
              const { x, y, type, count } = incomingAction;
              let errorRange = 1;
              if (type === 'bombard') {
                  errorRange = 1;
              } else if (type === 'spreadBombard') {
                  errorRange = 2;
              } else if (type === 'ppBombard') {
                  errorRange = 0;
              }

              logAction(`ä»–å³¶ã‹ã‚‰ ${count}ç™ºã®${type === 'bombard' ? 'ç ²æ’ƒ' : type === 'spreadBombard' ? 'æ‹¡æ•£å¼¾ç ²æ’ƒ' : 'PPå¼¾ç ²æ’ƒ'}ã‚’å—ã‘ã¾ã—ãŸï¼`);
              for (let i = 0; i < count; i++) {
                  let dx = 0;
                  let dy = 0;
                  if (errorRange > 0) {
                      dx = Math.floor(Math.random() * (2 * errorRange + 1)) - errorRange;
                      dy = Math.floor(Math.random() * (2 * errorRange + 1)) - errorRange;
                  }
                  const tx = x + dx;
                  const ty = y + dy;

                  if (tx >= 0 && ty >= 0 && tx < SIZE && ty < SIZE) {
                      const protectingFacility = getProtectingDefenseFacility(tx, ty); // å¤‰æ›´ç‚¹

                      if (protectingFacility) { // é˜²è¡›æ–½è¨­ãŒã‚ã£ãŸå ´åˆ
                          if (type === 'ppBombard') { // PPå¼¾ã ã£ãŸå ´åˆ
                              protectingFacility.facility = null; // é˜²è¡›æ–½è¨­ã‚’ç ´å£Š
                              protectingFacility.terrain = 'waste'; // é˜²è¡›æ–½è¨­ã®å ´æ‰€ã‚’è’åœ°ã«ã™ã‚‹
                              protectingFacility.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                              logAction(`(${tx},${ty}) ã‚’å®ˆã£ã¦ã„ãŸé˜²è¡›æ–½è¨­ãŒPPå¼¾ã«ã‚ˆã‚Šç ´å£Šã•ã‚Œã¾ã—ãŸï¼`);
                              // ãã®å¾Œã€PPå¼¾ã®åŠ¹æœã‚’é©ç”¨ï¼ˆæ—¢å­˜ã®æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ã«æµã‚Œã‚‹ï¼‰
                          } else { // PPå¼¾ã§ãªã‘ã‚Œã°é˜²è¡›æ–½è¨­ãŒå®ˆã‚‹
                              logAction(`ç ²æ’ƒã¯é˜²è¡›æ–½è¨­ã«ã‚ˆã‚Šç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ (${tx},${ty})`);
                              continue; // æ¬¡ã®æ”»æ’ƒã¸
                          }
                      }
                      // é˜²è¡›æ–½è¨­ãŒç ´å£Šã•ã‚ŒãŸã‹ã€å…ƒã€…å­˜åœ¨ã—ãªã„å ´åˆã€ä»¥ä¸‹ã®æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
                      const target = map[ty][tx];
                      if (target.terrain === 'mountain') { // è¿½åŠ 
                          logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã¯å±±ã«ç€å¼¾ã—ã¾ã—ãŸãŒã€è¢«å®³ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ(${tx},${ty})`); // è¿½åŠ 
                          continue; // è¿½åŠ 
                      }
                      if (target.terrain === 'sea') {
                          if (target.facility === 'port') {
                              target.facility = null;
                              logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã«ã‚ˆã‚Š (${tx},${ty}) ã®æ¸¯ãŒç ´å£Šã•ã‚Œã¾ã—ãŸ`);
                          } else {
                              const targetWarship = warships.find(ship => ship.x === tx && ship.y === ty);
                              if (targetWarship) {
                                  if (targetWarship.isDispatched) {
                                      logAction(`æ´¾é£ä¸­ã®è»è‰¦ã€Œ${targetWarship.name}ã€ã¸ã®ç ²æ’ƒã¯ç„¡åŠ¹ã§ã—ãŸã€‚`);
                                      continue;
                                  }
                                  targetWarship.currentDurability -= 1; // è€ä¹…å€¤1æ¸›å°‘
                                  checkAbnormalityOnDamage(targetWarship, damage);
                                  if (targetWarship.currentDurability <= 0) {
                            targetWarship.fuel = 0; // æ®‹ã‚Šç‡ƒæ–™ã‚’0ã«
                            targetWarship.currentFuel = 0; // ç¾åœ¨ç‡ƒæ–™ã‚‚0ã«
                            targetWarship.ammo = 0; // æ®‹ã‚Šå¼¾è–¬ã‚’0ã«
                            targetWarship.currentAmmo = 0; // ç¾åœ¨å¼¾è–¬ã‚‚0ã«
                                      warships = warships.filter(ship => ship !== targetWarship);
                                      logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã«ã‚ˆã‚Šè»è‰¦ã€Œ${targetWarship.name}ã€ãŒæ’ƒæ²ˆã•ã‚Œã¾ã—ãŸï¼`);
                                  } else {
                                      logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒãŒè»è‰¦ã€Œ${targetWarship.name}ã€ã«ç€å¼¾ã—ã¾ã—ãŸï¼ (æ®‹ã‚Šè€ä¹…: ${targetWarship.currentDurability})`);
                                  }
                              } else {
                                  logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã¯æµ·ã«ç€å¼¾ã—ã¾ã—ãŸ (${tx},${ty})`);
                              }
                          }
                      } else { // é™¸åœ°ã®å ´åˆ
                          if (target.facility) {
                              if (target.facility === 'house') {
                                  population -= target.pop;
                                  if (population < 0) population = 0;
                              }
                              target.facility = null;
                              target.enhanced = false; // æ–½è¨­ç ´å£Šæ™‚ã«å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                          }
                          target.terrain = 'waste';
                          logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã«ã‚ˆã‚Š (${tx},${ty}) ãŒç ´å£Šã•ã‚Œã¾ã—ãŸ`);
                      }
                      const monsterHit = monsters.find(m => m.x === tx && m.y === ty);
                      if (monsterHit) {
                          monsterHit.hp -= 1;
                          const monsterName = MONSTER_TYPES[monsterHit.typeId] ? MONSTER_TYPES[monsterHit.typeId].name : 'æ€ªç£';
                          logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒãŒ ${monsterName} ã«å‘½ä¸­ï¼ (æ®‹ã‚Šä½“åŠ›: ${monsterHit.hp})`);
                          if (monsterHit.hp <= 0) {
                              monsters = monsters.filter(m => m !== monsterHit);
                              logAction(`${monsterName} ã¯è¨ä¼ã•ã‚Œã¾ã—ãŸï¼`);
                          }
                      }
                  } else {
                      logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã¯é ˜åŸŸå¤–ã«ç€å¼¾ã—ã¾ã—ãŸ (${tx},${ty})`);
                  }
              }
          } else if (incomingAction.type === 'warshipDispatch') { // è»è‰¦æ´¾é£ã®å—ä¿¡å‡¦ç†
              const { warshipData, sourceIslandName } = incomingAction;
              const newWarship = decodeWarshipData(warshipData);

              // é©åˆ‡ãªæµ·åŸŸã‚’æ¢ã—ã¦é…ç½®
              const possibleSeaTiles = [];
              for (let y = 0; y < SIZE; y++) {
                  for (let x = 0; x < SIZE; x++) {
                      const tile = map[y][x];
                      const existingWarship = warships.find(ship => ship.x === x && ship.y === y);
                      if (tile.terrain === 'sea' && tile.facility === null && !existingWarship) {
                          possibleSeaTiles.push({ x, y });
                      }
                  }
              }

              if (possibleSeaTiles.length > 0) {
                  const randomIndex = Math.floor(Math.random() * possibleSeaTiles.length);
                  const { x, y } = possibleSeaTiles[randomIndex];
                  newWarship.x = x;
                  newWarship.y = y;
                  newWarship.isDispatched = false; // æ´¾é£ã•ã‚ŒãŸè»è‰¦ã¯ã€ãã®å³¶ã§ã¯æ´¾é£ä¸­ã§ã¯ãªã„
                  warships.push(newWarship);
                  logAction(`ã€Œ${sourceIslandName}ã€ã‹ã‚‰è»è‰¦ã€Œ${newWarship.name}ã€ãŒæ´¾é£ã•ã‚Œã¾ã—ãŸï¼ (${x},${y}) ã«åˆ°ç€ã€‚`);
              } else {
                  logAction(`ã€Œ${sourceIslandName}ã€ã‹ã‚‰æ´¾é£ã•ã‚ŒãŸè»è‰¦ã€Œ${newWarship.name}ã€ã¯é…ç½®ã§ãã‚‹æµ·åŸŸãŒãªãã€å¸°é‚„ã—ã¾ã—ãŸã€‚`);
              }
          } else if (incomingAction.type === 'warshipReturnRequest') {
              const { homePort, name } = incomingAction;
              const warshipToReturn = warships.find(ship =>
                  ship.homePort === homePort &&
                  ship.name === name &&
                  !ship.isDispatched // ã“ã®å³¶ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªï¼ˆæ´¾é£ä¸­ã§ãªã„ï¼‰è»è‰¦
              );

              if (warshipToReturn) {
                  // æœ€æ–°ã®è»è‰¦æƒ…å ±ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                  const encodedWarshipData = encodeWarshipData(warshipToReturn);
                  const returnConfirmationData = {
                      type: "warshipReturnConfirmation", // å¸°é‚„ç¢ºèªã‚¿ã‚¤ãƒ—
                      warshipData: encodedWarshipData,
                      originalHomePort: warshipToReturn.homePort
                  };
                  const encodedReturnConfirmationAction = btoa(encodeURIComponent(JSON.stringify(returnConfirmationData)));
                  document.getElementById('actionForOtherIslandOutput').value = encodedReturnConfirmationAction;

                  // è»è‰¦ã‚’ã“ã®å³¶ã‹ã‚‰å‰Šé™¤
                  warships = warships.filter(ship => ship !== warshipToReturn);
                  logAction(`è»è‰¦ã€Œ${warshipToReturn.name}ã€(${warshipToReturn.homePort}ç±) ã®å¸°é‚„è¦è«‹ã‚’å—ã‘ã€è¿”é€ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã—ã€è‡ªå³¶ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
              } else {
                  logAction(`å¸°é‚„è¦è«‹ã•ã‚ŒãŸè»è‰¦ã€Œ${name}ã€(${homePort}ç±) ã¯ã€ã“ã®å³¶ã«ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸã€‚`);
              }
          } else if (incomingAction.type === 'warshipReturnConfirmation') { // è»è‰¦å¸°é‚„ç¢ºèªã®å—ä¿¡å‡¦ç† (æ¯æ¸¯å´)
              const { warshipData, originalHomePort } = incomingAction;
              const returnedWarshipData = decodeWarshipData(warshipData);
              const existingWarship = warships.find(ship =>
                  ship.homePort === returnedWarshipData.homePort &&
                  ship.name === returnedWarshipData.name &&
                  ship.isDispatched === true // æ¯æ¸¯ã§æ´¾é£ä¸­ã¨ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®
              );

              if (existingWarship) {
                  // æœ€æ–°ã®è»è‰¦æƒ…å ±ã«æ›¸ãæ›ãˆã‚‹
                  existingWarship.exp = returnedWarshipData.exp;
                  existingWarship.currentFuel = returnedWarshipData.currentFuel;
                  existingWarship.maxFuel = returnedWarshipData.maxFuel; // maxFuelã‚‚æ›´æ–°
                  existingWarship.currentDurability = returnedWarshipData.currentDurability;
                  existingWarship.mainGun = returnedWarshipData.mainGun;
                  existingWarship.torpedo = returnedWarshipData.torpedo;
                  existingWarship.antiAir = returnedWarshipData.antiAir;
                  existingWarship.maxAmmo = returnedWarshipData.maxAmmo;
                  existingWarship.currentAmmo = returnedWarshipData.currentAmmo;
                  existingWarship.reconnaissance = returnedWarshipData.reconnaissance;
                  existingWarship.accuracyImprovement = returnedWarshipData.accuracyImprovement;

                  existingWarship.isDispatched = false; // æ´¾é£çŠ¶æ…‹ã‚’è§£é™¤

                  logAction(`è»è‰¦ã€Œ${existingWarship.name}ã€ãŒæ¯æ¸¯ã€Œ${originalHomePort}ã€ã«å¸°é‚„ã—ã¾ã—ãŸï¼æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã€æ´¾é£çŠ¶æ…‹ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸã€‚`);
              } else {
                  logAction(`å¸°é‚„ã—ãŸè»è‰¦ã€Œ${returnedWarshipData.name}ã€ã¯ã€ã“ã®å³¶ã§å¯¾å¿œã™ã‚‹æ´¾é£ä¸­ã®è»è‰¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
              }
          }
      } catch (e) {
          logAction("ä»–å³¶ã‹ã‚‰ã®è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          console.error(e);
      }
  }


  // å¿…ãšè‡ªåˆ†ã®å³¶ã«æˆ»ã‚‹
  if (isViewingOtherIsland) {
      loadMyIslandState(); // è‡ªåˆ†ã®å³¶ã«æˆ»ã‚‹
      document.getElementById('actionForOtherIslandOutput').value = ''; // ä»–å³¶ã¸ã®è¡Œå‹•ã‚’ã‚¯ãƒªã‚¢
      logAction("ã‚¿ãƒ¼ãƒ³ãŒé€²ã‚“ã ãŸã‚ã€è‡ªå³¶ã«æˆ»ã‚Šã¾ã—ãŸã€‚");
  }
  handleWarshipAttacks()
  let foodChange = 0, moneyChange = 0;
  let prevPopulation = population; // å‰ã‚¿ãƒ¼ãƒ³ã®äººå£ã‚’ä¿å­˜
  let currentTurnPopulationGrowth = 0; // ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã§ã®äººå£å¢—åŠ ã‚’ãƒªã‚»ãƒƒãƒˆ

  // è¡Œå‹•ã‚­ãƒ¥ãƒ¼ã®å‡¦ç† (æœ€å¤§2ã¤ã¾ã§å®Ÿè¡Œ)
const ACTIONS_PER_TURN = 2; // 1ã‚¿ãƒ¼ãƒ³ã«å®Ÿè¡Œã™ã‚‹è¨ˆç”»ã®æ•°
for (let i = 0; i < ACTIONS_PER_TURN; i++) {
    if (actionQueue.length === 0) {
        break; // ã‚­ãƒ¥ãƒ¼ãŒç©ºã«ãªã£ãŸã‚‰çµ‚äº†
    }
    // actionQueue.shift() ã«ã‚ˆã‚Šã€å®Ÿè¡Œã—ãŸè¨ˆç”»ã¯ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ã•ã‚Œã‚‹ï¼ˆæ®‹ã‚Šã¯ä¿æŒã•ã‚Œã‚‹ï¼‰
    const task = actionQueue.shift(); 
    const x = task.x;
    const y = task.y;
    const action = task.action;
    let tile = null;
    if (x !== null && y !== null) {
        tile = map[y][x];
    }
    if (x !== null && y !== null) {
      tile = map[y][x];
    }else if (action === 'buildWarship') {
  const { warshipData } = task;
  const existingWarship = warships.find(ship => ship.x === x && ship.y === y);
  if (existingWarship) {
    logAction(`(${x},${y}) ã«ã¯æ—¢ã«è»è‰¦ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€å»ºé€ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
    continue;
  }

const newWarship = {
        x: selectedX,
        y: selectedY,
        homePort: islandName,
        name: document.getElementById('warshipName').value || "ç„¡éŠ˜è‰¦",
        exp: 0,
        currentFuel: Math.min(WARSHIP_CAPS.maxFuel, 100), // åˆæœŸç‡ƒæ–™ã‚‚ä¸Šé™è€ƒæ…®
        maxFuel: Math.min(WARSHIP_CAPS.maxFuel, 100), // åˆæœŸæœ€å¤§ç‡ƒæ–™ã‚‚ä¸Šé™è€ƒæ…®
        maxDurability: Math.min(WARSHIP_CAPS.maxDurability, parseInt(document.getElementById('warshipDurability').value)),
        currentDurability: Math.min(WARSHIP_CAPS.maxDurability, parseInt(document.getElementById('warshipDurability').value)),
        mainGun: Math.min(WARSHIP_CAPS.mainGun, parseInt(document.getElementById('warshipMainGun').value)),
        torpedo: parseInt(document.getElementById('warshipTorpedo').value), // é­šé›·ã«ã¯ä¸Šé™ãªã—
        antiAir: Math.min(WARSHIP_CAPS.antiAir, parseInt(document.getElementById('warshipAntiAir').value)),
        maxAmmo: Math.min(WARSHIP_CAPS.maxAmmo, parseInt(document.getElementById('warshipAmmo').value)),
        currentAmmo: Math.min(WARSHIP_CAPS.maxAmmo, parseInt(document.getElementById('warshipAmmo').value)),
        reconnaissance: parseInt(document.getElementById('warshipRecon').value),
        accuracyImprovement: parseInt(document.getElementById('warshipAccuracy').value),
        isDispatched: false, // æ´¾é£çŠ¶æ…‹
        originalCost: totalCost // å»ºé€ ã‚³ã‚¹ãƒˆã‚’ä¿å­˜
    };
  warships.push(newWarship);
  money -= warshipData.originalCost;
        map[currentAction.y][currentAction.x].facility = 'warship'; // åœ°å›³ã‚¿ã‚¤ãƒ«ã«è»è‰¦ãŒå»ºè¨­ã•ã‚ŒãŸã“ã¨ã‚’è¨˜éŒ²
  logAction(`(${x},${y}) ã«è»è‰¦ã€Œ${newWarship.name}ã€ã‚’å»ºé€ ã—ã¾ã—ãŸã€‚`);
}

    // ä½å®…ã®ä¸Šã«å»ºè¨­ã™ã‚‹éš›ã®å‡¦ç†ã‚’å…±é€šåŒ–
    const handleHouseOverwrite = (targetTile) => {
        if (targetTile && targetTile.facility === 'house') {
            population -= targetTile.pop;
            if (population < 0) population = 0;
            targetTile.facility = null;
            targetTile.pop = 0;
            logAction(`(${x},${y}) ã®ä½å®…ãŒå–ã‚Šå£Šã•ã‚Œã¾ã—ãŸã€‚`);
        }
    };
    if (action === 'delayAction') {
    }
    else if (action === 'buildFarm') {
      if (tile && tile.terrain === 'plain' && money >= 100) {
        handleHouseOverwrite(tile);
        tile.facility = 'farm';
        tile.enhanced = false; // æ–°è¦å»ºè¨­ã¯å¼·åŒ–ãªã—
        money -= 100;
        logAction(`(${x},${y}) ã«è¾²å ´ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
        checkAndCompleteMission('02', 1, 0, 250,() => map.flat().some(t => t.facility === 'farm'),'è¾²å ´ãŒ1ã¤ã§ã‚‚å»ºè¨­ã•ã‚Œã¦ã„ã‚‹');
      } else logAction(`(${x},${y}) ã®è¾²å ´å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'buildFactory') {
      if (tile && tile.terrain === 'plain' && money >= 100) {
        handleHouseOverwrite(tile);
        tile.facility = 'factory';
        tile.enhanced = false; // æ–°è¦å»ºè¨­ã¯å¼·åŒ–ãªã—
        money -= 100;
        logAction(`(${x},${y}) ã«å·¥å ´ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
        checkAndCompleteMission('03', 1, 0, 500,() => map.flat().some(t => t.facility === 'factory'),'å·¥å ´ãŒ1ã¤ã§ã‚‚å»ºè¨­ã•ã‚Œã¦ã„ã‚‹');
      } else logAction(`(${x},${y}) ã®å·¥å ´å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'flatten') {
      if (tile && tile.terrain === 'mountain') { // å¤‰æ›´
        logAction(`(${x},${y}) ã®æ•´åœ°ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆå±±ã¯ç ´å£Šã§ãã¾ã›ã‚“ï¼‰`);
        continue;
      }
      if (tile && (tile.terrain === 'waste' || tile.facility) && money >= 20) {
        money -= 20;
        if (tile.facility === 'house') {
            population -= tile.pop; // äººå£ã‚’å³æ™‚åæ˜ 
            if (population < 0) population = 0;
        }
        tile.terrain = 'plain'; tile.facility = null; tile.pop = 0; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã‚’æ•´åœ°ã—ã¦å¹³åœ°ã«ã—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®æ•´åœ°ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'buildMonument'){
      if (tile && tile.terrain === 'plain' && tile.facility != 'Monument' && money >= 500000000) {
        handleHouseOverwrite(tile);
        tile.facility = 'Monument';
        money -= 500000000;
        tile.MonumentLevel = 1;
        logAction(`(${x},${y}) ã«çŸ³ç¢‘ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
      } else {
        logAction(`(${x},${y}) ã®çŸ³ç¢‘å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      }
    }
    else if (action === 'upgradeMonument')
      if (tile && tile.facility === 'Monument' && money >= 500000000) {
        handleHouseOverwrite(tile);
        tile.MonumentLevel += 1;
        money -= 500000000;
        logAction(`(${x},${y}) ã®çŸ³ç¢‘ã‚’å¼·åŒ–ã—ã¾ã—ãŸ`);
      } else {
        logAction(`(${x},${y}) ã®çŸ³ç¢‘å¼·åŒ–ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      }
    else if (action === 'sellMonument')
      if (tile && tile.facility === 'Monument') {
        handleHouseOverwrite(tile);
        tile.terrain = 'plain'; tile.facility = null; tile.pop = 0; tile.enhanced = false
        money += 500000000 * tile.MonumentLevel;
        tile.MonumentLevel = 0;
        logAction(`(${x},${y}) ã®çŸ³ç¢‘ã‚’å£²å´ã—ã¾ã—ãŸ`);
      } else {
        logAction(`(${x},${y}) ã®çŸ³ç¢‘å£²å´ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      }
    else if (action === 'cutForest') {
      if (tile && tile.terrain === 'forest') {
        const gain = Math.floor(Math.random() * 421) + 80;
        money += gain; tile.terrain = 'plain'; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã‚’ä¼æ¡ã— ${gain}G ã‚’å¾—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®ä¼æ¡ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ£®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰`);
    }
    else if (action === 'plantForest') {
      if (tile && tile.terrain === 'plain' && tile.facility === null && money >= 200) {
        handleHouseOverwrite(tile);
        tile.terrain = 'forest';
        tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        money -= 200;
        logAction(`(${x},${y}) ã«æ¤æ—ã‚’è¡Œã„ã€æ£®ã«ã—ã¾ã—ãŸ`);
      } else {
        logAction(`(${x},${y}) ã®æ¤æ—ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      }
    }
    else if (action === 'buildGun') {
      if (tile && tile.terrain === 'plain' && money >= 1200) {
        handleHouseOverwrite(tile);
        tile.facility = 'gun'; money -= 1200; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã«ç ²å°ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
        const guns = map.flat().filter(t => t.facility === 'gun').length;
        checkAndCompleteMission('05', 1, 0, 1000,() => guns >= 3,'ç ²æ’ƒå¯èƒ½æ•°ãŒ3ä»¥ä¸Šã«ãªã‚‹');
      } else logAction(`(${x},${y}) ã®ç ²å°å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'buildDefenseFacility') { // é˜²è¡›æ–½è¨­å»ºè¨­
      if (tile && tile.terrain === 'plain' && money >= 5000) {
        handleHouseOverwrite(tile);
        tile.facility = 'defenseFacility';
        money -= 5000;
        tile.enhanced = false; // æ–°è¦å»ºè¨­ã¯å¼·åŒ–ãªã—
        logAction(`(${x},${y}) ã«é˜²è¡›æ–½è¨­ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
        checkAndCompleteMission('06', 1, 0, 1000, () => map.flat().some(t => t.facility === 'defenseFacility'),'é˜²è¡›æ–½è¨­ãŒ1ã¤ã§ã‚‚å»ºè¨­ã•ã‚Œã¦ã„ã‚‹');
      } else logAction(`(${x},${y}) ã®é˜²è¡›æ–½è¨­å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'landfill') {
      if (tile && tile.terrain === 'sea' && money >= 600) {
        tile.terrain = 'waste'; money -= 600; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã‚’åŸ‹ã‚ç«‹ã¦ã¦è’åœ°ã«ã—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®åŸ‹ã‚ç«‹ã¦ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæµ·ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'exportFood') {
      const amount = task.amount;
      if (food >= amount * 20) {
        food -= amount * 20; money += amount * 200;
        logAction(`é£Ÿæ–™ã‚’ ${amount * 20} è¼¸å‡ºã— ${amount * 200}G ã‚’å¾—ã¾ã—ãŸ`);
        checkAndCompleteMission('08', 2, 5000, 0, () => true, 'é£Ÿæ–™è¼¸å‡ºã‚’è¡Œã†');
      } else logAction(`é£Ÿæ–™è¼¸å‡ºã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé£Ÿæ–™ä¸è¶³ï¼‰`);
    }
    else if (action === 'buildPort') {
      if (tile && tile.terrain === 'sea' && !tile.facility && money >= 3000) {
        let adjacentLand = false;
        for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
            const nx = x + dx, ny = y + dy;
            if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && (dx !== 0 || dy !== 0) && map[ny][nx].terrain !== 'sea') {
              adjacentLand = true;
              break;
            }
          }
          if (adjacentLand) break;
        }
        if (adjacentLand) {
          tile.facility = 'port'; money -= 3000; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
          logAction(`(${x},${y}) ã«æ¸¯ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
        } else logAction(`(${x},${y}) ã®æ¸¯å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆé™¸åœ°ã«éš£æ¥ã—ã¦ã„ã¾ã›ã‚“ã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      } else logAction(`(${x},${y}) ã®æ¸¯å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'dig') {
    const tile = map[y][x];
    if (monsters.find(m => m.x === x && m.y === y)) {
        logAction(`(${x},${y}) ã®æ˜å‰Šã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ€ªç£ãŒã„ã¾ã™ï¼‰`);
        continue;
    }
    if (tile.terrain === 'mountain') {
        logAction(`(${x},${y}) ã®æ˜å‰Šã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆå±±ã¯æ˜å‰Šã§ãã¾ã›ã‚“ï¼‰`);
        continue; // è¿½åŠ  (æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã¸)
    }
    const oilFactor = task.oilFactor || 1; // confirmActionã§è¨­å®šã—ãŸå€¤ã€æœªè¨­å®šãªã‚‰1 
    // ã‚³ã‚¹ãƒˆè¨ˆç®—
    let cost = 300;
    if (tile.terrain === 'sea' && oilFactor > 1) {
        // æµ·ã‚’æ˜å‰Šã—ã€ã‹ã¤æ²¹ç”°ç™ºæ˜ç‡Lv > 1 ã®å ´åˆ: 300 * éšä¹—(å…¥åŠ›å€¤)
        // è¨‚æ­£ï¼š300 * å…¥åŠ›å€¤ã®2ä¹—
        cost = 300 * oilFactor ** 2;
    } 
    if (money < cost) {
        logAction(`(${x},${y}) ã®æ˜å‰Šã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³‡é‡‘ä¸è¶³: ${cost}G å¿…è¦ï¼‰`);
    } else {
        money -= cost;
        
        if (tile.terrain !== 'sea') {
            // æµ·ä»¥å¤–ã®åœ°å½¢ã‚’æ˜å‰Šã—ãŸå ´åˆ (å…¥åŠ›å€¤ã«é–¢ã‚ã‚‰ãšç™ºæ˜ã•ã‚Œãªã„)
            if (tile.facility === 'house') {
                population -= tile.pop;
                if (population < 0) population = 0;
            }
            tile.terrain = 'sea';
            tile.facility = null;
            tile.pop = 0;
            tile.enhanced = false;
            logAction(`(${x},${y}) ã‚’æ˜å‰Šã—ã¦æµ·ã«ã—ã¾ã—ãŸã€‚`);
        } else {
            // æµ·ã®åœ°å½¢ã‚’æ˜å‰Šã—ãŸå ´åˆ
            if (tile.facility === 'oilRig') {
                logAction(`(${x},${y}) ã«ã¯ã™ã§ã«æ²¹ç”°ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€ç™ºæ˜ã¯å¤±æ•—ã—ã¾ã—ãŸã€‚ (ã‚³ã‚¹ãƒˆ: ${cost}G)`);
            } else {
                // ç™ºæ˜ç‡ã®è¨ˆç®—
                // oilFactor=1 ã®å ´åˆ: 2%
                // oilFactor=n ã®å ´åˆ: 2% + (n-1) * 5%
                const drillProbability = 0.02 + (oilFactor - 1) * 0.05;
                
                if (Math.random() < drillProbability) {
                    tile.facility = 'oilRig';
                    logAction(`(${x},${y}) ã‚’æµ·ã«æ˜å‰Šã—ãŸçµæœã€æ²¹ç”°ã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼ (ã‚³ã‚¹ãƒˆ: ${cost}G, ç¢ºç‡: ${Math.round(drillProbability * 100)}%)`);
                } else {
                    logAction(`(${x},${y}) ã‚’æ˜å‰Šã—ã¾ã—ãŸãŒã€æ²¹ç”°ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ (ã‚³ã‚¹ãƒˆ: ${cost}G, ç¢ºç‡: ${Math.round(drillProbability * 100)}%)`);
                }
            }
        }
    }
}
    else if (action === 'bombard' || action === 'spreadBombard' || action === 'ppBombard') {
      const count = task.count || 1;
      const guns = map.flat().filter(t => t.facility === 'gun').length;
      let costPerShot = 0;
      let errorRange = 1; // ç ²æ’ƒã®èª¤å·®ç¯„å›²
      if (action === 'bombard') {
          costPerShot = 120;
          errorRange = 1;
      } else if (action === 'spreadBombard') {
          costPerShot = 500;
          errorRange = 2;
      } else if (action === 'ppBombard') {
          costPerShot = 10000000; // PPå¼¾ã®ä¾¡æ ¼ã‚’æ›´æ–°
          errorRange = 0; // èª¤å·®ãªã—
      }

      const usableGuns = Math.min(count, guns, Math.floor(money / costPerShot));

      if (usableGuns > 0) {
        let hits = 0;
        for (let i = 0; i < usableGuns; i++) {
          let dx = 0;
          let dy = 0;
          if (errorRange > 0) {
            dx = Math.floor(Math.random() * (2 * errorRange + 1)) - errorRange;
            dy = Math.floor(Math.random() * (2 * errorRange + 1)) - errorRange;
          }
          const tx = x + dx;
          const ty = y + dy;

          if (tx >= 0 && ty >= 0 && tx < SIZE && ty < SIZE) {
            const protectingFacility = getProtectingDefenseFacility(tx, ty); // å¤‰æ›´ç‚¹

            if (protectingFacility) { // é˜²è¡›æ–½è¨­ãŒã‚ã£ãŸå ´åˆ
                if (action === 'ppBombard') { // PPå¼¾ã ã£ãŸå ´åˆ
                    protectingFacility.facility = null; // é˜²è¡›æ–½è¨­ã‚’ç ´å£Š
                    protectingFacility.terrain = 'waste'; // é˜²è¡›æ–½è¨­ã®å ´æ‰€ã‚’è’åœ°ã«ã™ã‚‹
                    protectingFacility.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                    logAction(`(${tx},${ty}) ã‚’å®ˆã£ã¦ã„ãŸé˜²è¡›æ–½è¨­ãŒPPå¼¾ã«ã‚ˆã‚Šç ´å£Šã•ã‚Œã¾ã—ãŸï¼`);
                    // ãã®å¾Œã€PPå¼¾ã®åŠ¹æœã‚’é©ç”¨ï¼ˆæ—¢å­˜ã®æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ã«æµã‚Œã‚‹ï¼‰
                } else { // PPå¼¾ã§ãªã‘ã‚Œã°é˜²è¡›æ–½è¨­ãŒå®ˆã‚‹
                    renderMap();
                    logAction(`ç ²æ’ƒã¯é˜²è¡›æ–½è¨­ã«ã‚ˆã‚Šç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ (${tx},${ty})`);
                    continue; // æ¬¡ã®æ”»æ’ƒã¸
                }
            }
            // é˜²è¡›æ–½è¨­ãŒç ´å£Šã•ã‚ŒãŸã‹ã€å…ƒã€…å­˜åœ¨ã—ãªã„å ´åˆã€ä»¥ä¸‹ã®æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
            const target = map[ty][tx];
            const monsterHit = monsters.find(m => m.x === tx && m.y === ty);
            if (monsterHit) {
                monsterHit.hp -= 1;
                const monsterName = MONSTER_TYPES[monsterHit.typeId] ? MONSTER_TYPES[monsterHit.typeId].name : 'æ€ªç£';
                logAction(`ç ²æ’ƒãŒ ${monsterName} ã«å‘½ä¸­ï¼ (æ®‹ã‚Šä½“åŠ›: ${monsterHit.hp})`);
                if (monsterHit.hp <= 0) {
                    monsters = monsters.filter(m => m !== monsterHit);
                    logAction(`${monsterName} ãŒç ²æ’ƒã«ã‚ˆã‚Šè¨ä¼ã•ã‚Œã¾ã—ãŸâ€¼`);
                }
                hits++; // å‘½ä¸­ã‚«ã‚¦ãƒ³ãƒˆ
                continue; // ã‚¿ã‚¤ãƒ«ç ´å£Šã¯ã‚¹ã‚­ãƒƒãƒ—
            }
            if (target.terrain === 'mountain') {
                logAction(`ç ²æ’ƒã¯å±±ã«ç€å¼¾ã—ã¾ã—ãŸãŒã€ç„¡åŠ¹ã§ã—ãŸã€‚ (${tx},${ty})`);
                continue;
            }
            if (target.terrain === 'sea') {
                if (target.facility === 'port') {
                    target.facility = null;
                    renderMap();
                    logAction(`ç ²æ’ƒã§ (${tx},${ty}) ã®æ¸¯ã‚’ç ´å£Šã—ã€æµ·ã«ãªã‚Šã¾ã—ãŸ`);
                } else {
                    // è»è‰¦ã¸ã®ç€å¼¾åˆ¤å®š
                    const targetWarship = warships.find(ship => ship.x === tx && ship.y === ty);
                    if (targetWarship) {
                        // æ´¾é£ä¸­ã®è»è‰¦ã¸ã®æ”»æ’ƒã¯ç„¡åŠ¹
                        if (targetWarship.isDispatched) {
                            logAction(`æ´¾é£ä¸­ã®è»è‰¦ã€Œ${targetWarship.name}ã€ã¸ã®ç ²æ’ƒã¯ç„¡åŠ¹ã§ã—ãŸã€‚`);
                            continue;
                        }
                        targetWarship.currentDurability -= 1; // è€ä¹…å€¤1æ¸›å°‘
                        if (targetWarship.currentDurability <= 0) {
                            warships = warships.filter(ship => ship !== targetWarship);
                            targetWarship.fuel = 0; // æ®‹ã‚Šç‡ƒæ–™ã‚’0ã«
                            targetWarship.currentFuel = 0; // ç¾åœ¨ç‡ƒæ–™ã‚‚0ã«
                            targetWarship.ammo = 0; // æ®‹ã‚Šå¼¾è–¬ã‚’0ã«
                            targetWarship.currentAmmo = 0; // ç¾åœ¨å¼¾è–¬ã‚‚0ã«
                            warships = warships.filter(ship => ship !== targetWarship);
                            logAction(`ç ²æ’ƒã«ã‚ˆã‚Šè»è‰¦ã€Œ${targetWarship.name}ã€ãŒæ’ƒæ²ˆã•ã‚Œã¾ã—ãŸï¼`);
                        } else {
                            logAction(`ç ²æ’ƒãŒè»è‰¦ã€Œ${targetWarship.name}ã€ã«ç€å¼¾ã—ã¾ã—ãŸï¼ (æ®‹ã‚Šè€ä¹…: ${targetWarship.currentDurability})`);
                        }
                    } else {
                        renderMap();
                        logAction(`ç ²æ’ƒã¯æµ·ã«ç€å¼¾ã—ã¾ã—ãŸ (${tx},${ty})`);
                    }
                }
            } else { // é™¸åœ°ã®å ´åˆ
                if (target.facility) {
                    if (target.facility === 'house') {
                        population -= target.pop;
                        if (population < 0) population = 0;
                    }
                }
                    target.facility = null;
                    target.enhanced = false; // æ–½è¨­ç ´å£Šæ™‚ã«å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                target.terrain = 'waste';
                logAction(`ç ²æ’ƒã§ (${tx},${ty}) ã‚’ç ´å£Šã—ã¾ã—ãŸ`);
            }

            // æ€ªç£ãŒå‘½ä¸­ã—ãŸã‹ãƒã‚§ãƒƒã‚¯(å‰Šé™¤æ¸ˆã¿)
            // if (monster && monster.x === tx && monster.y === ty) {
            //   monster = null;
            //   logAction(`æ€ªç£ãŒç ²æ’ƒã«ã‚ˆã‚Šè¨ä¼ã•ã‚Œã¾ã—ãŸâ€¼`);
            // }
            hits++;
          } else {
            logAction(`ç ²æ’ƒã¯é ˜åŸŸå¤–ã«ç€å¼¾ã—ã¾ã—ãŸ (${tx},${ty})`);
          }
        }
        money -= hits * costPerShot; // æˆåŠŸã—ãŸç ²æ’ƒã®æ•°ã ã‘è²»ç”¨ã‚’å¼•ã
      } else {
        logAction(`ç ²æ’ƒã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚`);
      }
    }
    else if (action === 'selfDestructMilitaryFacility') { // åç§°å¤‰æ›´
        if (tile && (tile.facility === 'gun' || tile.facility === 'defenseFacility')) { // ãƒãƒªãƒœãƒ†æ–½è¨­ã‚’å‰Šé™¤
            tile.facility = null;
            tile.terrain = 'sea';
            tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
            logAction(`(${x},${y}) ã®è»äº‹æ–½è¨­ãŒè‡ªçˆ†ã—ã€æµ·ã«ãªã‚Šã¾ã—ãŸã€‚`);
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    const nx = x + dx;
                    const ny = y + dy;

                    if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE) {
                        const targetWarship = warships.find(ship => ship.x === nx && ship.y === ny);
                        
                        // å­˜åœ¨ã™ã‚‹è»è‰¦ã§ã€ã‹ã¤æ²ˆæ²¡çŠ¶æ…‹ã§ã¯ãªã„ã€ã‹ã¤æ´¾é£ä¸­ã§ã¯ãªã„ï¼ˆè‡ªå³¶ã«ã„ã‚‹ï¼‰å ´åˆ
                        if (targetWarship && targetWarship.currentDurability > 0 && !targetWarship.isDispatched) {
                            // 5ã‹ã‚‰10ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ç”Ÿæˆ (Math.floor(Math.random() * 6) + 5)
                            const damage = Math.floor(Math.random() * 6) + 5;                           
                            targetWarship.currentDurability -= damage;
                            checkAbnormalityOnDamage(targetWarship, damage);
                            if (targetWarship.currentDurability <= 0) {
                                targetWarship.currentDurability = 0;
                                targetWarship.currentFuel = 0; // æ²ˆæ²¡ã—ãŸã‚‰ç‡ƒæ–™0
                                targetWarship.currentAmmo = 0; // æ²ˆæ²¡ã—ãŸã‚‰å¼¾è–¬0
                                logAction(`è‡ªçˆ†ã«ã‚ˆã‚Šè»è‰¦ ${targetWarship.name} (${nx},${ny}) ã¯${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘æ’ƒæ²ˆã—ã¾ã—ãŸï¼`);
                            } else {
                                logAction(`è‡ªçˆ†ã«ã‚ˆã‚Šè»è‰¦ ${targetWarship.name} (${nx},${ny}) ã¯${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¾ã—ãŸã€‚æ®‹ã‚Šè€ä¹…: ${targetWarship.currentDurability}`);
                        const monsterHit = monsters.find(m => m.x === nx && m.y === ny);
                            }
                        if (monsterHit) {
                            const damage = Math.floor(Math.random() * 6) + 5; // 5ï½10ãƒ€ãƒ¡ãƒ¼ã‚¸
                            monsterHit.hp -= damage;
                            const monsterName = MONSTER_TYPES[monsterHit.typeId] ? MONSTER_TYPES[monsterHit.typeId].name : 'æ€ªç£';
                            logAction(`è‡ªçˆ†ã«ã‚ˆã‚Š ${monsterName} (${nx},${ny}) ã¯${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¾ã—ãŸã€‚æ®‹ã‚Šä½“åŠ›: ${monsterHit.hp}`);
                            if (monsterHit.hp <= 0) {
                                monsters = monsters.filter(m => m !== monsterHit);
                                logAction(`${monsterName} ã¯è‡ªçˆ†ã«å·»ãè¾¼ã¾ã‚Œè¨ä¼ã•ã‚Œã¾ã—ãŸï¼`);
                            }
                        }
                    }
                }
            }            }
            // å‘¨å›²1ãƒã‚¹ã‚’è’åœ°ã«ã™ã‚‹
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && !(dx === 0 && dy === 0)) {
                        const affectedTile = map[ny][nx];
                        if (affectedTile.terrain !== 'sea') { // æµ·ä»¥å¤–ã®åœ°å½¢ã‚’è’åœ°ã«ã™ã‚‹
                            if (affectedTile.facility === 'house') {
                                population -= affectedTile.pop;
                                if (population < 0) population = 0;
                            }
                            affectedTile.terrain = 'waste';
                            affectedTile.facility = null;
                            affectedTile.pop = 0;
                            affectedTile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                            logAction(`(${nx},${ny}) ãŒè»äº‹æ–½è¨­è‡ªçˆ†ã«ã‚ˆã‚Šè’åœ°ã«ãªã‚Šã¾ã—ãŸã€‚`);
                        }
                    }
                }
            }
        } else {
            logAction(`(${x},${y}) ã«è»äº‹æ–½è¨­ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
        }
    }
    else if (action === 'enhanceFacility') { // è¨­å‚™å¼·åŒ–
        if (tile && (tile.facility === 'farm' || tile.facility === 'factory'|| tile.facility === 'oilRig') && !tile.enhanced && money >= 10000) {
tile.enhanced = true;
        money -= 10000;
        
        let facilityName;
        if (tile.facility === 'farm') facilityName = 'è¾²å ´';
        else if (tile.facility === 'factory') facilityName = 'å·¥å ´';
        else if (tile.facility === 'oilRig') facilityName = 'æµ·åº•æ²¹ç”°';
        logAction(`(${x},${y}) ã®${facilityName}ãŒå¼·åŒ–ã•ã‚Œã¾ã—ãŸã€‚`);
            checkAndCompleteMission('04', 1, 0, 1000, () => true, 'å·¥å ´ã¾ãŸã¯è¾²å ´ã«è¨­å‚™å¼·åŒ–ã‚’è¡Œã†');
        } else {
            logAction(`(${x},${y}) ã®è¨­å‚™å¼·åŒ–ã¯å¤±æ•—ã—ã¾ã—ãŸã€‚`);
        }
    } else if (action === 'buildWarship') { // è»è‰¦å»ºé€ 
        const { name, durability, mainGun, torpedo, antiAir, ammo, recon, accuracy, cost } = task.warshipData;

        // å†åº¦ã€å ´æ‰€ã¨è²»ç”¨ã‚’ç¢ºèª
        let adjacentToPort = false;
        for (let dx = -1; dx <= 1; dx++) {
            for (let dy = -1; dy <= 1; dy++) {
                const nx = x + dx;
                const ny = y + dy;
                if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && (dx !== 0 || dy !== 0)) {
                    if (map[ny][nx].facility === 'port') {
                        adjacentToPort = true;
                        break;
                    }
                }
            }
            if (adjacentToPort) break;
        }
        // Check if a warship already exists at the selected tile
        const existingWarship = warships.find(ship => ship.x === x && ship.y === y);

            const newWarship = {
                x: x,
                y: y,
                homePort: islandName,
                name: name,
                exp: 0,
                currentFuel: 0, // åˆæœŸç‡ƒæ–™0
                maxFuel: 100, // ä»®ã®æœ€å¤§ç‡ƒæ–™
                maxDurability: durability,
                currentDurability: durability,
                mainGun: mainGun,
                torpedo: torpedo,
                antiAir: antiAir,
                maxAmmo: ammo,
                currentAmmo: 0, // åˆæœŸå¼¾è–¬0
                reconnaissance: recon,
                accuracyImprovement: accuracy,
                isDispatched: false,
                abnormality: null
            };
let hiyou = (durability * 10000000) + (mainGun * 12000000) + (torpedo * 10000000) + (antiAir * 5000000) + (ammo * 100000) + (recon * 12500000) + (accuracy * 50000000);
            warships.push(newWarship);
            money = money - hiyou;
            logAction(`è»è‰¦ã€Œ${name}ã€ã‚’ (${x},${y}) ã«å»ºé€ ã—ã¾ã—ãŸï¼`);

    } else if (action === 'refuelWarship') { // ç‡ƒæ–™è£œçµ¦
        const warship = warships.find(ship => ship.x === x && ship.y === y);
        if (warship && !warship.isDispatched) {
            const amount = task.amount;
            const cost = amount * 500;
            if (food >= cost) {
                const actualRefuelAmount = Math.min(amount, warship.maxFuel - warship.currentFuel);
                warship.currentFuel += actualRefuelAmount;
                food -= cost;
                logAction(`è»è‰¦ã€Œ${warship.name}ã€ã«ç‡ƒæ–™ã‚’ ${actualRefuelAmount} è£œçµ¦ã—ã¾ã—ãŸã€‚`);
            } else {
                logAction(`è»è‰¦ã€Œ${warship.name}ã€ã¸ã®ç‡ƒæ–™è£œçµ¦ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé£Ÿæ–™ä¸è¶³ï¼‰ã€‚`);
            }
        } else {
            logAction(`(${x},${y}) ã«ã¯è»è‰¦ãŒå­˜åœ¨ã—ãªã„ã‹ã€æ´¾é£ä¸­ã§ã—ãŸã€‚`);
        }
    } else if (action === 'resupplyWarshipAmmo') { // å¼¾è–¬è£œçµ¦
        const warship = warships.find(ship => ship.x === x && ship.y === y);
        if (warship && !warship.isDispatched) {
            const amount = task.amount;
            const cost = amount * 20000;
            if (money >= cost) {
                const actualResupplyAmount = Math.min(amount, warship.maxAmmo - warship.currentAmmo);
                warship.currentAmmo += actualResupplyAmount;
                money -= cost;
                logAction(`è»è‰¦ã€Œ${warship.name}ã€ã«å¼¾è–¬ã‚’ ${actualResupplyAmount} è£œçµ¦ã—ã¾ã—ãŸã€‚`);
            } else {
                logAction(`è»è‰¦ã€Œ${warship.name}ã€ã¸ã®å¼¾è–¬è£œçµ¦ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³‡é‡‘ä¸è¶³ï¼‰ã€‚`);
            }
        } else {
            logAction(`(${x},${y}) ã«ã¯è»è‰¦ãŒå­˜åœ¨ã—ãªã„ã‹ã€æ´¾é£ä¸­ã§ã—ãŸã€‚`);
        }
    } else if (action === 'dispatchWarship') { // è»è‰¦æ´¾é£ (ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã®å®Ÿè¡Œ)
        // ã“ã®å‡¦ç†ã¯confirmActionã§ä»–å³¶ã¸ã®è¡Œå‹•ã¨ã—ã¦å‡ºåŠ›æ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã›ãšã‚¹ã‚­ãƒƒãƒ—
        // è»è‰¦ã®isDispatchedãƒ•ãƒ©ã‚°ã¨ç‡ƒæ–™0ã¯confirmActionã§æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
    } else if (action === 'requestWarshipReturn') { // è»è‰¦å¸°é‚„è¦è«‹ (ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã®å®Ÿè¡Œ)
        // ã“ã®å‡¦ç†ã‚‚confirmActionã§ä»–å³¶ã¸ã®è¡Œå‹•ã¨ã—ã¦å‡ºåŠ›æ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã›ãšã‚¹ã‚­ãƒƒãƒ—
    }
  }
  // è»è‰¦ã®ç§»å‹• (æ´¾é£ä¸­ã®è»è‰¦ã¯ç§»å‹•ã—ãªã„)
  for (const warship of warships) {
      if (!warship.isDispatched && warship.currentFuel >= 1) { // æ´¾é£ä¸­ã§ãªã„è»è‰¦ã®ã¿ç§»å‹•
            if (warship.abnormality === 'flooding') {
                logAction(`è»è‰¦ ${warship.name} ã¯æµ¸æ°´ã—ã¦ã„ã‚‹ãŸã‚ã€ç§»å‹•ã§ãã¾ã›ã‚“ã€‚`);
                continue; // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¸
            }
          warship.currentFuel -= 1; // ç‡ƒæ–™æ¶ˆè²»
          const possibleMoves = [];
          for (let dx = -1; dx <= 1; dx++) {
              for (let dy = -1; dy <= 1; dy++) {
                  const nx = warship.x + dx;
                  const ny = warship.y + dy;
                  if (dx === 0 && dy === 0) continue;
                  // ãƒãƒƒãƒ—ç¯„å›²å†…ã§ã‚ã‚‹ã“ã¨
                  if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE) {
                      const targetTile = map[ny][nx];
                      // æµ·ã§ã‚ã‚‹ã“ã¨ã€å»ºç‰©ãŒãªã„ã“ã¨ã€ä»–ã®è»è‰¦ãŒã„ãªã„ã“ã¨
                      const isSeaWithoutFacilityOrWarship = (targetTile.terrain === 'sea' && targetTile.facility === null && !warships.some(otherShip => otherShip !== warship && otherShip.x === nx && otherShip.y === ny));
                      if (isSeaWithoutFacilityOrWarship) {
                          possibleMoves.push({ x: nx, y: ny });
                      }
                  }
              }
          }

          if (possibleMoves.length > 0) {
              const randomIndex = Math.floor(Math.random() * possibleMoves.length);
              const newPos = possibleMoves[randomIndex];
              logAction(`è»è‰¦ã€Œ${warship.name}ã€ã¯ (${warship.x},${warship.y}) ã‹ã‚‰ (${newPos.x},${newPos.y}) ã¸ç§»å‹•ã—ã¾ã—ãŸã€‚`);
              warship.x = newPos.x;
              warship.y = newPos.y;
          } else {
              logAction(`è»è‰¦ã€Œ${warship.name}ã€ã¯ç§»å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆç§»å‹•å¯èƒ½ãªãƒã‚¹ãŒãªã„ï¼‰ã€‚`);
          }
      }
  }

  // ç”Ÿç”£ï¼†æˆé•·å‡¦ç†
  for (let y = 0; y < SIZE; y++) {
    for (let x = 0; x < SIZE; x++) {
      const tile = map[y][x];
      if (tile.facility === 'farm' && tile.terrain === 'plain') {
          if (volcanoTurns === 0) { // å™´ç«ä¸­ã¯ç”£å‡ºãªã—
              foodChange += tile.enhanced ? 300 : 100; // å¼·åŒ–è¾²å ´ã¯é£Ÿæ–™300
          }
      }
      if (tile.facility === 'house') {
        const growth = Math.floor(Math.random() * 151 + 50);
        const added = Math.min(7500 - tile.pop, growth);
        if (volcanoTurns === 0) { // è¿½åŠ 
            tile.pop += added;
            currentTurnPopulationGrowth += added;
        }
      }
      if (tile.facility === 'factory') {
          // å¤‰æ›´ç®‡æ‰€ï¼šçµŒæ¸ˆå±æ©Ÿã®å½±éŸ¿ã‚’åæ˜ 
          let divisor;
          if (economicCrisisTurns > 0) {
              // çµŒæ¸ˆå±æ©Ÿä¸­
              if (tile.enhanced) {
                  // å¼·åŒ–å·¥å ´ (é€šå¸¸1.5å€) ã®ç”Ÿç”£ãŒ 0.2å€ ã«ãªã‚‹
                  // å…ƒã®ç”Ÿç”£é¡: pop / (4 / 1.5)
                  // ã“ã® 0.2å€: (pop / (4 / 1.5)) * 0.2 = pop / ((4 / 1.5) / 0.2) = pop / (4 / (1.5 * 0.2)) = pop / (4 / 0.3)
                  divisor = 4 / 0.3; 
              } else {
                  // é€šå¸¸å·¥å ´ (é€šå¸¸1.0å€) ã®ç”Ÿç”£ãŒ 0.5å€ ã«ãªã‚‹
                  // å…ƒã®ç”Ÿç”£é¡: pop / 4
                  // ã“ã® 0.5å€: (pop / 4) * 0.5 = pop / (4 / 0.5)
                  divisor = 4 / 0.5;
              }
          } else {
              // çµŒæ¸ˆå±æ©Ÿã§ã¯ãªã„
              divisor = tile.enhanced ? (4 / 1.5) : 4;
          }
          moneyChange += Math.floor(population / divisor);
      }
    }
  }

if (turn > 0 && turn % 50 === 0) {
    const monumentLevel = getMonumentLevel(); // A. ã§è¿½åŠ ã—ãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã™
    if (monumentLevel > 0) {
        const expIncrease = monumentLevel * 5;
        let increasedCount = 0;

        warships.forEach(ship => {
            // 1. æ¯æ¸¯ãŒç¾åœ¨ã®å³¶åã¨åŒã˜
            // 2. expãŒ"NaN"ã§ãªã„ï¼ˆç‰¹æ®Šè‰¦ã®é™¤å¤–ï¼‰
            // 3. æ²ˆæ²¡ã—ã¦ã„ãªã„
            if (ship.homePort === islandName && ship.exp !== "NaN" && ship.currentDurability > 0) {
                ship.exp += expIncrease;
                increasedCount++;
            }
        });

        if (increasedCount > 0) {
            logAction(`[çŸ³ç¢‘åŠ¹æœ] ${islandName}ç±ã®è»è‰¦ ${increasedCount}éš»ã«çµŒé¨“å€¤ ${expIncrease} ã‚’ä»˜ä¸ã—ã¾ã—ãŸï¼ (Lv${monumentLevel}åŠ¹æœ)`);
        }
    }
}
let totalOilRigIncome = 0;
let oilRigLoss = 0;
let remainingOilRigCount = 0; // æ®‹å­˜æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ

for (let y = 0; y < SIZE; y++) { 
    for (let x = 0; x < SIZE; x++) { 
        const tile = map[y][x]; 
        if (tile.facility === 'oilRig') {
            
            // åå…¥è¨ˆç®—: å¼·åŒ–ãªã‚‰2åŸºç›¸å½“ (2000G)ã€ãã†ã§ãªã‘ã‚Œã°1åŸºç›¸å½“ (1000G)
            const income = tile.enhanced ? 50000 : 25000; 
            totalOilRigIncome += income;
            
            // æ¯æ¸‡ç‡è¨ˆç®—: æ—¢å­˜ã®æ¯æ¸‡ç‡ã‚’0.02ã¨ä»®å®šã—ã€å¼·åŒ–ãªã‚‰1.75å€ (0.035)
            const baseLossRate = 0.02; 
            const lossRate = tile.enhanced ? baseLossRate * 1.75 : baseLossRate; 
            if (Math.random() < lossRate) { 
                oilRigLoss++; 
                const facilityName = tile.enhanced ? 'é«˜åŠ¹ç‡æµ·åº•æ²¹ç”°' : 'æµ·åº•æ²¹ç”°';
                
                tile.facility = null; 
                tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ 
                
                logAction(`(${x},${y}) ã®${facilityName}ãŒæ¯æ¸‡ã—ã¾ã—ãŸã€‚`); 
            } else {
                remainingOilRigCount++;
            }
        } 
    } 
}
moneyChange += totalOilRigIncome; // åˆè¨ˆåå…¥ã‚’åŠ ç®—
if (remainingOilRigCount > 0 || totalOilRigIncome > 0) {
    logAction(`æµ·åº•æ²¹ç”°ã‹ã‚‰${totalOilRigIncome}Gã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`); 
}
  for (let y = 0; y < SIZE; y++) {
    for (let x = 0; x < SIZE; x++) {
      const tile = map[y][x];
      if (tile.facility === 'farm') {
        for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
            const nx = x + dx, ny = y + dy;
            if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && (dx !== 0 || dy !== 0) && map[ny][nx].terrain === 'plain' && !map[ny][nx].facility && Math.random() < 0.1) {
              map[ny][nx].facility = 'house'; map[ny][nx].pop = 50;
              currentTurnPopulationGrowth += 50;
              logAction(`(${nx},${ny}) ã«ä½å®…ãŒè‡ªå‹•å½¢æˆã•ã‚Œã¾ã—ãŸ`);
            }
          }
        }
      }
    }
  }

  population += currentTurnPopulationGrowth; // åˆè¨ˆã®äººå£å¢—åŠ åˆ†ã‚’åæ˜ 
  checkAndCompleteMission('07', 2, 1000, 0, () => population >= 50000, 'ç·äººå£ãŒ5ä¸‡äººã«é”ã™ã‚‹');
  foodChange -= Math.floor(population / 200) * 5;
  food += foodChange;
  money += moneyChange;
// ç«å±±ã®å™´ç« æŒç¶šå‡¦ç† (è¿½åŠ )
    if (volcanoTurns > 0) {
        volcanoTurns--;
        if (volcanoTurns === 0) {
            logAction(`å™´ç«ã«ã‚ˆã‚‹é™ç°ãŒçµ‚æ¯ã—ã¾ã—ãŸã€‚è¾²å ´ã¨äººå£å¢—åŠ ãŒæ­£å¸¸ã«æˆ»ã‚Šã¾ã™ã€‚`);
        } else {
            logAction(`å™´ç«ã«ã‚ˆã‚‹é™ç°ã¯ã‚ã¨ ${volcanoTurns} ã‚¿ãƒ¼ãƒ³ç¶šãã¾ã™...`);
        }
    }
// çµŒæ¸ˆå±æ©Ÿã®ç™ºç”Ÿåˆ¤å®š
    if (economicCrisisTurns === 0 && (money + frozenMoney) >= 100000000) {
        const baseMoney = 1500000000;
        const currentTotalMoney = money + frozenMoney;
        const excessMoney = Math.max(0, currentTotalMoney - baseMoney); // 0æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ã«    
        const baseProbability = 0.01; // 1%
        const additionalProbability = Math.floor(excessMoney / 100000000) * 0.002; // 1å„„Gã”ã¨ã« 0.2%
        const totalProbability = baseProbability + additionalProbability;
        
        if (Math.random() < totalProbability) {
            // çµŒæ¸ˆå±æ©Ÿç™ºç”Ÿ
            economicCrisisTurns = Math.floor(Math.random() * 26) + 10; // 10ï½35ã‚¿ãƒ¼ãƒ³
            const frozenPercentage = Math.random() * 0.5 + 0.4; // 40%ï½90%
            frozenMoney = Math.floor(currentTotalMoney * frozenPercentage);
            money = currentTotalMoney - frozenMoney; // ä½¿ãˆã‚‹ãŠé‡‘ã‚’æ¸›ã‚‰ã™
            
            logAction(`çµŒæ¸ˆå±æ©ŸãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ ${economicCrisisTurns}ã‚¿ãƒ¼ãƒ³ã®é–“ã€è³‡é‡‘ã®${Math.round(frozenPercentage * 100)}% (${frozenMoney}G)ãŒå‡çµã•ã‚Œã¾ã™ï¼`);
        }
    } 
    // çµŒæ¸ˆå±æ©Ÿã®æŒç¶šå‡¦ç†
    else if (economicCrisisTurns > 0) {
        economicCrisisTurns--;
        if (economicCrisisTurns === 0) {
            logAction(`çµŒæ¸ˆå±æ©ŸãŒçµ‚æ¯ã—ã¾ã—ãŸã€‚å‡çµã•ã‚Œã¦ã„ãŸ ${frozenMoney}G ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`);
            money += frozenMoney;
            frozenMoney = 0;
        } else {
            logAction(`çµŒæ¸ˆå±æ©Ÿã¯ã‚ã¨ ${economicCrisisTurns} ã‚¿ãƒ¼ãƒ³ç¶šãã¾ã™...`);
        }
    }
  // æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆï¼šå¤§åœ°ã®éš†èµ·
  const hasMountain = map.flat().some(tile => tile.terrain === 'mountain');
  if (!hasMountain && Math.random() < 0.08) { // 8%
      const x = Math.floor(Math.random() * (SIZE - 2)) + 1; // ç«¯ã‚’é™¤ã (1ï½14)
      const y = Math.floor(Math.random() * (SIZE - 2)) + 1; // ç«¯ã‚’é™¤ã (1ï½14)

      logAction(`å³¶ã®ä¸­å¤®éƒ¨ (${x},${y}) ã§å¤§åœ°ã®éš†èµ·ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼`);

      for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
              const nx = x + dx;
              const ny = y + dy;
              
              if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE) {
                  const tile = map[ny][nx];

                  // å¯¾è±¡ãŒè»è‰¦ã®å ´åˆ (è¿½åŠ )
                  const targetWarship = warships.find(ship => ship.x === nx && ship.y === ny);
                  if (targetWarship) {
                      warships = warships.filter(ship => ship !== targetWarship);
                      logAction(`éš†èµ·ã«å·»ãè¾¼ã¾ã‚Œã€è»è‰¦ã€Œ${targetWarship.name}ã€ãŒç ´å£Šã•ã‚Œã¾ã—ãŸï¼`);
                  }
                  if (tile.facility === 'house') {
                      population -= tile.pop;
                      if (population < 0) population = 0;
                  }
                  
                  if (dx === 0 && dy === 0) {
                      tile.terrain = 'mountain'; // å±±ã«ãªã‚‹
                      tile.facility = null;
                      tile.pop = 0;
                      tile.enhanced = false;
                      logAction(`(${nx},${ny}) ãŒå±±ã«ãªã‚Šã¾ã—ãŸã€‚`);
                  } else {
                      if (tile.terrain !== 'sea' && tile.terrain !== 'mountain') { // æµ·ã¨å±±ä»¥å¤–
                          tile.terrain = 'waste';
                          tile.facility = null;
                          tile.pop = 0;
                          tile.enhanced = false;
                      }
                  }
              }
          }
      }
  }
  // æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆï¼šç«å±±ã®å™´ç«
  if (volcanoTurns === 0 && hasMountain && food >= 500000 && turn >= 500 && Math.random() < 0.01) { // 1%
      volcanoTurns = 12;
      logAction(`ç«å±±ãŒå™´ç«ã—ã¾ã—ãŸï¼ ${volcanoTurns}ã‚¿ãƒ¼ãƒ³ã®é–“ã€é™ç°ã«ã‚ˆã‚Šè¾²å ´ã®ç”Ÿç”£ã¨äººå£å¢—åŠ ãŒåœæ­¢ã—ã¾ã™ï¼`);
  }
  // å°é¢¨ã‚¤ãƒ™ãƒ³ãƒˆ
  if (Math.random() < 0.035) { // å°é¢¨ç™ºç”Ÿç¢ºç‡
    logAction(`å³¶ã«å°é¢¨ãŒä¸Šé™¸â€¼`)
    for (let y = 0; y < SIZE; y++) {
      for (let x = 0; x < SIZE; x++) {
        const tile = map[y][x];
        if (tile.facility === 'farm') {
          // é˜²è¡›æ–½è¨­ã«ã‚ˆã‚‹ä¿è­·ã‚’ãƒã‚§ãƒƒã‚¯
          if (getProtectingDefenseFacility(x, y)) {
              continue;
          }

          let forestCount = 0;
          for (let dx = -1; dx <= 1; dx++) {
            for (let dy = -1; dy <= 1; dy++) {
              const nx = x + dx, ny = y + dy;
              if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && map[ny][nx].terrain === 'forest') {
                forestCount++;
              }
            }
          }
          let destroyChance = (8 - forestCount / 12) / 2;
          if (tile.enhanced) {
              destroyChance /= 2; // å¼·åŒ–è¾²å ´ã¯ç ´å£Šç¢ºç‡ãŒåŠåˆ†
          }

          if (Math.random() < destroyChance / 10) {
            tile.terrain = 'plain';
            tile.facility = null;
            tile.enhanced = false;
            logAction(`(${x},${y})ã®è¾²å ´ã¯å°é¢¨ã«ã‚ˆã‚Šå¹ãé£›ã°ã•ã‚Œã¾ã—ãŸã€‚`);
          }
        }
      }
    }
  }
if (turn >= 1000 && Math.random() < 0.001) { // 0.1% = 0.001
    logAction(`å·¨å¤§åœ°éœ‡ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼å³¶å…¨ä½“ã«ç”šå¤§ãªè¢«å®³ãŒäºˆæƒ³ã•ã‚Œã¾ã™ï¼`);
    earthquakeEffect();
}
  // éš•çŸ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ1.8%ï¼‰
  if (Math.random() < 0.018) {
    const x = Math.floor(Math.random() * SIZE);
    const y = Math.floor(Math.random() * SIZE);

    const protectingFacility = getProtectingDefenseFacility(x, y); // å¤‰æ›´ç‚¹

    const tile = map[y][x];
    const label = tile.facility ? (tile.facility === 'farm' ? 'è¾²å ´' : tile.facility === 'factory' ? 'å·¥å ´' : 'ä½å®…') : tile.terrain;
    const targetWarship = warships.find(ship => ship.x === x && ship.y === y);
    if (targetWarship) {
        if (targetWarship.isDispatched) {
            logAction(`æ´¾é£ä¸­ã®è»è‰¦ã€Œ${targetWarship.name}ã€ã¸ã®éš•çŸ³è¡çªã¯ç„¡åŠ¹ã§ã—ãŸã€‚`);
        } else {
            targetWarship.currentDurability -= 35;
            if (targetWarship.currentDurability <= 0) {
                warships = warships.filter(ship => ship !== targetWarship);
                logAction(`éš•çŸ³ã«ã‚ˆã‚Šè»è‰¦ã€Œ${targetWarship.name}ã€ãŒç •ã‘æ•£ã‚Šã¾ã—ãŸâ€¦`);
            } else {
                logAction(`éš•çŸ³ãŒè»è‰¦ã€Œ${targetWarship.name}ã€ã«å‘½ä¸­ã€ç”šå¤§ãªè¢«å®³ãŒå‡ºã¾ã—ãŸã€‚ (æ®‹ã‚Šè€ä¹…: ${targetWarship.currentDurability})`);
                checkAbnormalityOnDamage(targetWarship, damage);
            }
        }
    } else if (protectingFacility) {
        protectingFacility.facility = null; // é˜²è¡›æ–½è¨­ã‚’ç ´å£Š
        protectingFacility.terrain = 'waste'; // é˜²è¡›æ–½è¨­ã®å ´æ‰€ã‚’è’åœ°ã«ã™ã‚‹
        protectingFacility.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã«éš•çŸ³ãŒè½ä¸‹ã—ã¾ã—ãŸãŒã€é˜²è¡›æ–½è¨­ãŒé˜²å¾¡ã«æˆåŠŸã—ã¾ã—ãŸã€‚`);
        logAction(`é˜²è¡›æ–½è¨­ã¯è·å‹™ã‚’å…¨ã†ã—ã¾ã—ãŸã€‚`);
    }else {
        if (tile.facility === 'house') {
            population -= tile.pop;
            if (population < 0) population = 0;
        }

        tile.terrain = 'sea';
        tile.facility = null;
        tile.pop = 0;
        tile.enhanced = false;
        logAction(`å³¶ã«éš•çŸ³ãŒè½ä¸‹â€¼`)
        logAction(`(${x},${y})ã®${label}ã«éš•çŸ³ãŒè½ä¸‹ã—ã¾ã—ãŸã€‚`);
    }
  }
  if (food < 0) {
    logAction(`å³¶ã®é£Ÿæ–™ãŒä¸è¶³ã—ã¦ã„ã¾ã™â€¼`)
    for (let y = 0; y < SIZE; y++) {
      for (let x = 0; x < SIZE; x++) {
        const tile = map[y][x];
        if (tile.facility === 'house') {
          const lost = Math.floor(Math.random() * 201 + 300);
          tile.pop -= lost;
          population -= lost; // äººå£ã‚’å³æ™‚åæ˜ 
          if (population < 0) population = 0;
          if (tile.pop <= 0) {
            tile.terrain = 'waste';
            tile.facility = null;
            tile.pop = 0;
            tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
            logAction(`(${x},${y})ã®ä½å®…ã¯å»ƒå¢Ÿã¨ãªã‚Šã¾ã—ãŸã€‚`);
          }
        }
      }
    }
    const destroyChance = 0.05;
    if (Math.random() < destroyChance) {
      const allTargets = [];
      for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
          const tile = map[y][x];
          if (tile.facility === 'farm' || tile.facility === 'factory') {
            allTargets.push({ x, y });
          }
        }
      }
      if (allTargets.length > 0) {
        const { x, y } = allTargets[Math.floor(Math.random() * allTargets.length)];
        const label = map[y][x].facility === 'farm' ? 'è¾²å ´' : 'å·¥å ´';
        map[y][x].terrain = 'waste';
        map[y][x].facility = null;
        map[y][x].enhanced = false;
        logAction(`(${x},${y})ã®${label}ã§é£Ÿæ–™ä¸è¶³ã«ã‚ˆã‚Šä½æ°‘ãŒæ®ºåˆ°ã€å´©å£Šã—ã¾ã—ãŸã€‚`);
      }
    }
  }
  if (food < 0) food = 0;

  // 1. å‡ºç¾å€™è£œåœ° (ä½å®…) ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
  const spawnCandidates = [];
  for (let y = 0; y < SIZE; y++) {
    for (let x = 0; x < SIZE; x++) {
      const tile = map[y][x];
      // ä½å®…ã§ã‚ã‚Šã€ã‹ã¤ä»–ã®æ€ªç£ãŒã„ãªã„å ´æ‰€
      if (tile.facility === 'house' && !monsters.find(m => m.x === x && m.y === y)) {
        spawnCandidates.push({ x, y });
      }
    }
  }
  if (spawnCandidates.length > 0) {
      // 2. å‡ºç¾åˆ¤å®š (ç¨®é¡ã”ã¨)
      for (const typeId in MONSTER_TYPES) {
          const type = MONSTER_TYPES[typeId];
          
          // 3. å‡ºç¾æ¡ä»¶ãƒã‚§ãƒƒã‚¯ (äººå£) ã¨ç¢ºç‡ (1%)
          if (type.condition(population) && Math.random() < 0.01) {
              
              // 4. å‡ºç¾å ´æ‰€ã®æ±ºå®š (å€™è£œåœ°ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ )
              if (spawnCandidates.length === 0) break; 
              const spawnIndex = Math.floor(Math.random() * spawnCandidates.length);
              const spawn = spawnCandidates[spawnIndex];
              
              // 5. ä½“åŠ›(HP)ã®æ±ºå®š
              const hp = Math.floor(Math.random() * (type.maxHP - type.minHP + 1)) + type.minHP;

              // 6. æ€ªç£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿæˆ
              const newMonster = { 
                  x: spawn.x, 
                  y: spawn.y, 
                  typeId: parseInt(typeId),
                  hp: hp
              };
              monsters.push(newMonster);

              // 7. å‡ºç¾å ´æ‰€ã®ç ´å£Š
              const spawnedTile = map[spawn.y][spawn.x];
              if (spawnedTile.facility === 'house') {
                  population -= spawnedTile.pop;
                  if (population < 0) population = 0;
              }
              spawnedTile.terrain = 'waste';
              spawnedTile.facility = null;
              spawnedTile.pop = 0;
              spawnedTile.enhanced = false; 
              
              logAction(`(${spawn.x},${spawn.y}) ã« ${type.name} (ä½“åŠ›: ${hp}) ãŒå‡ºç¾â€¼`);
              
              // 8. å‡ºç¾ã—ãŸå ´æ‰€ã‚’å€™è£œåœ°ã‹ã‚‰å‰Šé™¤
              spawnCandidates.splice(spawnIndex, 1);
          }
      }
  }

// æ€ªç£ã®ç§»å‹•ã¨èƒ½åŠ›
  const monstersThisTurn = [...monsters]; 
  
  for (const monster of monstersThisTurn) {
      // (ã‚‚ã—è¨ä¼ã•ã‚Œã¦é…åˆ—ã‹ã‚‰æ¶ˆãˆã¦ã„ãŸã‚‰ã‚¹ã‚­ãƒƒãƒ—)
      if (!monsters.includes(monster)) continue; 
      
      const monsterType = MONSTER_TYPES[monster.typeId];
      if (!monsterType) continue; // ä¸æ˜ãªæ€ªç£ã¯ã‚¹ã‚­ãƒƒãƒ—

      // 1. ç§»å‹•å‡¦ç† (ã‚¢ã‚¨ãƒ­ã‚¬ãƒ­ã‚¹ã¯ç‰¹åˆ¥)
      let moveCount = 1;
      if (monsterType.ability === 'multiMove') {
          moveCount = Math.floor(Math.random() * 11); // 0ï½10å›
          if (moveCount > 0) {
              logAction(`${monsterType.name} ã¯ ${moveCount} å›ç§»å‹•ã™ã‚‹ï¼`);
          }
      }

      for (let i = 0; i < moveCount; i++) {
          // (å†åº¦ã€è¨ä¼ãƒã‚§ãƒƒã‚¯)
          if (!monsters.includes(monster)) break; 
          
          const directions = [
            { dx: 0, dy: -1 }, { dx: 0, dy: 1 }, { dx: -1, dy: 0 }, { dx: 1, dy: 0 }
          ];
          const possible = directions.filter(({ dx, dy }) => {
            const nx = monster.x + dx;
            const ny = monster.y + dy;
            return nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && 
                   map[ny][nx].terrain !== 'sea' && // é™¸åœ°ã®ã¿
                   !monsters.find(m => m.x === nx && m.y === ny); // ä»–ã®æ€ªç£ãŒã„ãªã„
          });

          if (possible.length > 0) {
            const { dx, dy } = possible[Math.floor(Math.random() * possible.length)];
            const nx = monster.x + dx;
            const ny = monster.y + dy;
            const targetTile = map[ny][nx];
            
            // (é˜²è¡›æ–½è¨­ç ´å£Šãƒ­ã‚¸ãƒƒã‚¯ã¯å…±é€š)
            const protectingFacility = getProtectingDefenseFacility(nx, ny);
            if (protectingFacility) {
                protectingFacility.facility = null;
                protectingFacility.terrain = 'waste';
                protectingFacility.enhanced = false;
                logAction(`${monsterType.name}ã«ã‚ˆã£ã¦ (${nx},${ny}) ã‚’å®ˆã£ã¦ã„ãŸé˜²è¡›æ–½è¨­ãŒç ´å£Šã•ã‚Œã¾ã—ãŸï¼`);
            }

            if (targetTile.facility === 'house') {
              population -= targetTile.pop;
              if (population < 0) population = 0;
            }
            targetTile.terrain = 'waste';
            targetTile.facility = null;
            targetTile.pop = 0;
            targetTile.enhanced = false; 

            logAction(`${monsterType.name} ãŒ (${nx},${ny}) ã‚’è¸ã¿è’ã‚‰ã—ã¾ã—ãŸã€‚`);
            monster.x = nx;
            monster.y = ny;
          }
      } // (multiMove ãƒ«ãƒ¼ãƒ—çµ‚ã‚ã‚Š)
      
      // (å†åº¦ã€è¨ä¼ãƒã‚§ãƒƒã‚¯)
      if (!monsters.includes(monster)) continue; 

      // 2. ç‰¹æ®Šèƒ½åŠ›ã®å‡¦ç†
      if (monsterType.ability === 'destroyArea' && Math.random() < 0.10) { // ãƒ´ã‚©ãƒ«ã‚«ã‚¬ãƒ­ã‚¹ (10%)
          logAction(`${monsterType.name} ãŒå‘¨å›²ã®é™¸åœ°ã‚’ç ´å£Šï¼`);
          for (let dx = -1; dx <= 1; dx++) {
              for (let dy = -1; dy <= 1; dy++) {
                  if (dx === 0 && dy === 0) continue;
                  const nx = monster.x + dx;
                  const ny = monster.y + dy;
                  if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE) {
                      const tile = map[ny][nx];
                      if (tile.terrain !== 'sea' && !monsters.find(m => m.x === nx && m.y === ny)) { // æµ·ã¨ä»–ã®æ€ªç£ä»¥å¤–
                          if (tile.facility === 'house') {
                              population -= tile.pop;
                              if (population < 0) population = 0;
                          }
                          tile.terrain = 'waste';
                          tile.facility = null;
                          tile.pop = 0;
                          tile.enhanced = false;
                      }
                  }
              }
          }
      } 
      else if (monsterType.ability === 'landfillSea' && Math.random() < 0.15) { // ãƒ†ãƒ©ã‚¬ãƒ­ã‚¹ (15%)
          // è’åœ°ã«ã™ã‚‹æµ·ï¼ˆè»è‰¦å«ã‚€ï¼‰ã‚’æ¢ã™
          const seaTiles = [];
          for (let y = 0; y < SIZE; y++) {
              for (let x = 0; x < SIZE; x++) {
                  if (map[y][x].terrain === 'sea') {
                      seaTiles.push({ x, y });
                  }
              }
          }
          if (seaTiles.length > 0) {
              const { x, y } = seaTiles[Math.floor(Math.random() * seaTiles.length)];
              const targetWarship = warships.find(ship => ship.x === x && ship.y === y);
              
              if (targetWarship && targetWarship.currentDurability > 0 && !targetWarship.isDispatched) {
                  logAction(`${monsterType.name} ãŒ (${x},${y}) ã®æµ·ã‚’åŸ‹ã‚ç«‹ã¦ã‚ˆã†ã¨ã—ã€è»è‰¦ã€Œ${targetWarship.name}ã€ã«10ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                  targetWarship.currentDurability -= 10;
                  checkAbnormalityOnDamage(targetWarship, 10);
                  if (targetWarship.currentDurability <= 0) {
                      targetWarship.currentDurability = 0;
                      targetWarship.currentFuel = 0;
                      targetWarship.currentAmmo = 0;
                      logAction(`è»è‰¦ ${targetWarship.name} ã¯æ’ƒæ²ˆã—ã¾ã—ãŸï¼`);
                  }
              } else {
                  logAction(`${monsterType.name} ãŒ (${x},${y}) ã®æµ·ã‚’è’åœ°ã«å¤‰ãˆã¾ã—ãŸï¼`);
                  map[y][x].terrain = 'waste';
                  map[y][x].facility = null;
                  map[y][x].enhanced = false;
              }
          }
      }
      else if (monsterType.ability === 'createSea') { // ã‚¢ã‚¯ã‚¢ã‚¬ãƒ­ã‚¹ (æ¯ã‚¿ãƒ¼ãƒ³)
          // é™¸åœ°ã‚¿ã‚¤ãƒ«ã‚’æ¢ã™ (è‡ªåˆ†è‡ªèº«ã¨ä»–ã®æ€ªç£ã€å±±ã€çŸ³ç¢‘ã‚’é™¤ã)
          const landTiles = [];
          for (let y = 0; y < SIZE; y++) {
              for (let x = 0; x < SIZE; x++) {
                  const tile = map[y][x];
                  if (tile.terrain !== 'sea' && tile.terrain !== 'mountain' && tile.facility !== 'Monument' &&
                      !(monster.x === x && monster.y === y) && 
                      !monsters.find(m => m !== monster && m.x === x && m.y === y)) 
                  {
                      landTiles.push({ x, y });
                  }
              }
          }
          if (landTiles.length > 0) {
              const { x, y } = landTiles[Math.floor(Math.random() * landTiles.length)];
              const tile = map[y][x];
              const facilityNameMap = {
                  farm: 'è¾²å ´',
                  house: 'ä½å®…',
                  factory: 'å·¥å ´',
                  gun: 'ç ²å°',
                  port: 'æ¸¯',
                  defenseFacility: 'é˜²è¡›æ–½è¨­',
                  Monument: 'çŸ³ç¢‘',
                  oilRig: 'æµ·åº•æ²¹ç”°'
              };
              const facilityName = tile.facility ? (facilityNameMap[tile.facility] || tile.facility) : tile.terrain;
              logAction(`${monsterType.name} ãŒ (${x},${y}) ã®${facilityName}ã‚’æµ·ã«å¤‰ãˆã¾ã—ãŸï¼`);
              if (tile.facility === 'house') {
                  population -= tile.pop;
                  if (population < 0) population = 0;
              }
              tile.terrain = 'sea';
              tile.facility = null;
              tile.pop = 0;
              tile.enhanced = false;
          }
      }
  }

let gunCount = 0;
let defenseFacilityCount = 0;
let portCount = 0;
// ãƒãƒƒãƒ—ä¸Šã®æ–½è¨­æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
map.forEach(row => {
    row.forEach(tile => {
        if (tile.facility === 'gun') gunCount++;
        else if (tile.facility === 'defenseFacility') defenseFacilityCount++;
        else if (tile.facility === 'port') portCount++;
    });
});
// æ²ˆæ²¡ã—ã¦ã„ãªã„è»è‰¦ï¼ˆcurrentDurability > 0ï¼‰ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
const activeWarshipCount = warships.filter(ship => ship.currentDurability > 0).length;
const facilityMaintenance = (gunCount * 600) + (defenseFacilityCount * 2000) + (portCount * 2500);
const warshipMaintenance = activeWarshipCount * 20000;
let maintenanceCost = facilityMaintenance + warshipMaintenance;
let maintenanceMultiplier = 1;
if (economicCrisisTurns > 0) {
    maintenanceMultiplier = 16; // çµŒæ¸ˆå±æ©Ÿä¸­ã¯ç¶­æŒè²»16å€
}
const actualMaintenanceCost = maintenanceCost * maintenanceMultiplier;
if (actualMaintenanceCost > 0) {
    money -= actualMaintenanceCost;
    let logMsg = `ç¶­æŒè²» ${actualMaintenanceCost}G ã‚’è³‡é‡‘ã‹ã‚‰å·®ã—å¼•ãã¾ã—ãŸã€‚ï¼ˆç ²å°:${gunCount}ã€é˜²è¡›æ–½è¨­:${defenseFacilityCount}ã€æ¸¯:${portCount}ã€è»è‰¦:${activeWarshipCount}ï¼‰`;
    if (maintenanceMultiplier > 1) {
        logMsg += ` (çµŒæ¸ˆå±æ©Ÿã«ã‚ˆã‚Š${maintenanceMultiplier}å€)`;
    }
    logAction(logMsg);
    // è³‡é‡‘ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã£ãŸå ´åˆã¯0ã«ç½®ãæ›ãˆã‚‹
    if (money < 0) {
        money = 0;
        logAction('è³‡é‡‘ä¸è¶³ã«ã‚ˆã‚Šç¶­æŒãŒå›°é›£ã«ãªã£ã¦ã„ã¾ã™ï¼');
    }
}
  saveMyIslandState(); // ã‚¿ãƒ¼ãƒ³çµ‚äº†å¾Œã€è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
  updateStatus();
  renderActionQueue()
  const populationChange = population - prevPopulation; // äººå£ã®å¢—æ¸›ã‚’è¨ˆç®—
  logAction(`è³‡é‡‘åæ”¯: ${moneyChange+totalOilRigIncome - actualMaintenanceCost}G, é£Ÿæ–™: ${foodChange >= 0 ? '+' : ''}${foodChange}, äººå£å¤‰åŒ–: ${populationChange >= 0 ? '+' : ''}${populationChange}`);
  renderMap();
}
/**
 * åœ°éœ‡ãƒ»æ´¥æ³¢ã®åŠ¹æœã‚’å‡¦ç†ã™ã‚‹
 * 1. åœ°éœ‡åŠ¹æœ (ãƒ©ãƒ³ãƒ€ãƒ ãªé™¸åœ°ã‚¿ã‚¤ãƒ«5ã€œ12å€‹ã®è’åœ°åŒ–)
 * 2. æ´¥æ³¢åŠ¹æœ (æ²¿å²¸ã‚¿ã‚¤ãƒ«ã®è’åœ°åŒ–/æµ·åŒ–ã€æ¸¯ãƒ»æ²¹ç”°ã®ç ´å£Šã€è»è‰¦ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸)
 */
function earthquakeEffect() {
    // ------------------------------------
    // 1. åœ°éœ‡åŠ¹æœ (é™¸åœ°ã‚¿ã‚¤ãƒ«ã®è’åœ°åŒ–)
    // ------------------------------------
    const affectedTiles = []; 
    for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
            const tile = map[y][x];
            // é™¸åœ°ã‚¿ã‚¤ãƒ«ã‹ã¤çŸ³ç¢‘ã§ã¯ãªã„ã“ã¨ã‚’ç¢ºèª
            if (tile.terrain !== 'sea' && tile.facility !== 'Monument') {
                affectedTiles.push({ x, y });
            }
        }
    }

    const numToDestroy = Math.floor(Math.random() * 8) + 5; // 5ã‹ã‚‰12
    affectedTiles.sort(() => 0.5 - Math.random()); // ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    const landDestroyed = affectedTiles.slice(0, numToDestroy);

    landDestroyed.forEach(({ x, y }) => {
        const tile = map[y][x];
        
        if (tile.facility === 'house') {
            population -= tile.pop;
            if (population < 0) population = 0;
            logAction(`(${x},${y})ã®ä½å®…ãŒåœ°éœ‡ã«ã‚ˆã‚Šç ´å£Šã•ã‚Œã¾ã—ãŸã€‚`);
        } else {
            logAction(`(${x},${y})ã®${tile.facility || tile.terrain}ãŒåœ°éœ‡ã«ã‚ˆã‚Šç ´å£Šã•ã‚Œè’åœ°ã«ãªã‚Šã¾ã—ãŸã€‚`);
        }

        tile.terrain = 'waste';
        tile.facility = null;
        tile.pop = 0;
        tile.enhanced = false;
    });

    if (landDestroyed.length > 0) {
        logAction(`åœ°éœ‡ã«ã‚ˆã‚Š ${landDestroyed.length} å€‹ã®é™¸åœ°ã‚¿ã‚¤ãƒ«ãŒè’åœ°ã«ãªã‚Šã¾ã—ãŸã€‚`);
    } else {
        logAction(`åœ°éœ‡ã«ã‚ˆã‚‹é™¸åœ°ã®ç›´æ¥çš„ãªè¢«å®³ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
    }

    logAction(`æ´¥æ³¢ãŒå³¶ã«æŠ¼ã—å¯„ã›ã¾ã™...`);

    // ------------------------------------
    // 2. æ´¥æ³¢åŠ¹æœ
    // ------------------------------------
    let portsDestroyed = 0;
    let oilRigsDestroyed = 0;
    let totalTilesAffected = 0;

    for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
            const tile = map[y][x];
            if (tile.facility === 'Monument') continue; // çŸ³ç¢‘ã¯ä¾‹å¤–

            // æµ·ã¾ãŸã¯æœ€å¤–å‘¨ã«éš£æ¥ã™ã‚‹é™¸åœ°ã‚¿ã‚¤ãƒ«ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹
            const isLand = tile.terrain !== 'sea';
            let isAdjacentToSea = false;
            
            // å‘¨å›²8ãƒã‚¹ã«æµ·ãŒã‚ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && map[ny][nx].terrain === 'sea') {
                        isAdjacentToSea = true;
                        break;
                    }
                }
                if (isAdjacentToSea) break;
            }

            // A. æ²¹ç”°ã¨æ¸¯ã®ç ´å£Š (æµ·ã‚¿ã‚¤ãƒ«ã§ã‚‚éš£æ¥é™¸åœ°ã‚¿ã‚¤ãƒ«ã§ã‚‚å…¨ã¦ç ´å£Š)
            if (tile.facility === 'oilRig' || tile.facility === 'port') {
                 // æ—¢ã«æ´¥æ³¢ã§ç ´å£Šã•ã‚Œã‚‹å¯¾è±¡ãªã®ã§ã€ä»¥é™ã®ãƒ©ãƒ³ãƒ€ãƒ ç ´å£Šã¯ç„¡è¦–ã•ã‚Œã‚‹
            } else if (!isLand || !isAdjacentToSea) {
                // é™¸åœ°ã§ãªãã€ã‹ã¤æµ·ã«éš£æ¥ã—ã¦ã„ãªã„é™¸åœ°ã§ã‚‚ãªã„ï¼ˆã¤ã¾ã‚Šå†…é™¸ã®é™¸åœ°ã€ã¾ãŸã¯å†…é™¸ã®æµ·ï¼‰ã¯å¯¾è±¡å¤–
                continue;
            }

            // ç ´å£Šå‡¦ç†
            if (tile.facility === 'oilRig' || tile.facility === 'port') {
                if (tile.facility === 'oilRig') oilRigsDestroyed++;
                if (tile.facility === 'port') portsDestroyed++;
                logAction(`æ´¥æ³¢ã«ã‚ˆã‚Š (${x},${y}) ã®${tile.facility === 'oilRig' ? 'æ²¹ç”°' : 'æ¸¯'}ãŒç ´å£Šã•ã‚Œæµ·ã«ãªã‚Šã¾ã—ãŸã€‚`);
                tile.terrain = 'sea';
                tile.facility = null;
                tile.pop = 0;
                tile.enhanced = false;
                totalTilesAffected++;
            } else if (isAdjacentToSea) { // æµ·ã«éš£æ¥ã™ã‚‹é™¸åœ°ã‚¿ã‚¤ãƒ«ã«å¯¾ã™ã‚‹ãƒ©ãƒ³ãƒ€ãƒ ç ´å£Š
                const r = Math.random();
                if (r < 0.30) { // 30%ã®ç¢ºç‡ã§è’åœ°
                    if (tile.facility === 'house') {
                        population -= tile.pop;
                        if (population < 0) population = 0;
                        logAction(`æ´¥æ³¢ã«ã‚ˆã‚Š (${x},${y})ã®ä½å®…ãŒç ´å£Šã•ã‚Œè’åœ°ã«ãªã‚Šã¾ã—ãŸã€‚`);
                    } else {
                        logAction(`æ´¥æ³¢ã«ã‚ˆã‚Š (${x},${y})ã®${tile.facility || tile.terrain}ãŒè’åœ°ã«ãªã‚Šã¾ã—ãŸã€‚`);
                    }
                    tile.terrain = 'waste';
                    tile.facility = null;
                    tile.pop = 0;
                    tile.enhanced = false;
                    totalTilesAffected++;
                } else if (r < 0.30 + 0.20) { // 20%ã®ç¢ºç‡ã§æµ·
                    if (tile.facility === 'house') {
                        population -= tile.pop;
                        if (population < 0) population = 0;
                        logAction(`æ´¥æ³¢ã«ã‚ˆã‚Š (${x},${y})ã®ä½å®…ãŒç ´å£Šã•ã‚Œæµ·ã«ãªã‚Šã¾ã—ãŸã€‚`);
                    } else {
                        logAction(`æ´¥æ³¢ã«ã‚ˆã‚Š (${x},${y})ã®${tile.facility || tile.terrain}ãŒæµ·ã«ãªã‚Šã¾ã—ãŸã€‚`);
                    }
                    tile.terrain = 'sea';
                    tile.facility = null;
                    tile.pop = 0;
                    tile.enhanced = false;
                    totalTilesAffected++;
                }
            }
        }
    }
    
    // æ»åœ¨ä¸­ã®è»è‰¦ã¸ã®ãƒ€ãƒ¡ãƒ¼ã‚¸
    warships.forEach(ship => {
        // è‡ªå³¶ã«ã„ã¦ã€æ²ˆæ²¡ã—ã¦ãŠã‚‰ãšã€æ´¾é£ä¸­ã§ãªã„èˆ¹
        if (ship.homePort === islandName && ship.currentDurability > 0 && !ship.isDispatched) {
            const damage = 2;
            ship.currentDurability -= damage;
            checkAbnormalityOnDamage(ship, damage);
            logAction(`æ´¥æ³¢ã«ã‚ˆã‚Šè»è‰¦ ${ship.name} ãŒ ${damage} ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¾ã—ãŸã€‚`);
            if (ship.currentDurability <= 0) {
                ship.currentDurability = 0;
                logAction(`è»è‰¦ ${ship.name} ã¯æ´¥æ³¢ã«ã‚ˆã‚Šæ²ˆæ²¡ã—ã¾ã—ãŸã€‚`);
            }
        }
    });

    if (totalTilesAffected > 0 || portsDestroyed > 0 || oilRigsDestroyed > 0) {
        logAction(`æ´¥æ³¢ã«ã‚ˆã‚Šæ²¿å²¸éƒ¨ ${totalTilesAffected} ãƒã‚¹ã«è¢«å®³ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ï¼ˆæ¸¯ ${portsDestroyed}ã€æ²¹ç”° ${oilRigsDestroyed} ã‚’å«ã‚€ï¼‰`);
    } else {
         logAction(`æ´¥æ³¢ã¯ã‚ã‚Šã¾ã—ãŸãŒã€æ²¿å²¸éƒ¨ã¸ã®è¢«å®³ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
    }
}
function getMonumentLevel() {
    for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
            const tile = map[y][x];
            // çŸ³ç¢‘ãŒå­˜åœ¨ã—ã€ãƒ¬ãƒ™ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (tile.facility === 'Monument' && tile.MonumentLevel > 0) {
                return tile.MonumentLevel;
            }
        }
    }
    return 0;
}
// ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½
window.saveGame = function() {
    islandName = document.getElementById('islandNameInput').value; // UIã‹ã‚‰åå‰ã‚’å–å¾—
    saveMyIslandState(); // è‡ªåˆ†ã®å³¶ã®æœ€æ–°ã®çŠ¶æ…‹ã‚’ä¿å­˜

    const gameState = {
        map: myIslandState.map,
        money: myIslandState.money,
        food: myIslandState.food,
        population: myIslandState.population,
        turn: myIslandState.turn,
        achievementPoints : myIslandState.achievementPoints,
        tutorialMissions : myIslandState.tutorialMissions,
        islandName: myIslandState.islandName,
        monster: myIslandState.monster,
        actionQueue: myIslandState.actionQueue,
        warships: myIslandState.warships,
        economicCrisisTurns: myIslandState.economicCrisisTurns,
        frozenMoney: myIslandState.frozenMoney,
        volcanoTurns: myIslandState.volcanoTurns
    };
    const jsonString = JSON.stringify(gameState);

    // æ–‡å­—åˆ—ã‚’Unicodeã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®é…åˆ—ã«å¤‰æ›ã—ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§çµåˆ
    const encodedData = Array.from(jsonString).map(char => char.charCodeAt(0)).join(',');

    document.getElementById('saveLoadData').value = encodedData;
    logAction("ã‚²ãƒ¼ãƒ ãŒã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
    updateStatus(); // å³¶ã®åå‰ã®å¤‰æ›´ã‚’UIã«åæ˜ 
}

// ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
window.loadGame = function() {
    const encodedData = document.getElementById('saveLoadData').value;
    if (!encodedData) {
        logAction("ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
        return;
    }

    try {
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã‚’Unicodeã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®é…åˆ—ã«æˆ»ã—ã€æ–‡å­—åˆ—ã«å¤‰æ›
        const charCodes = encodedData.split(',').map(Number);
        const jsonString = String.fromCharCode(...charCodes);

        const gameState = JSON.parse(jsonString);
        map = gameState.map;
        money = gameState.money;
        food = gameState.food;
        population = gameState.population;
        turn = gameState.turn;
        achievementPoints = gameState.achievementPoints || 0; // å®Ÿç¸¾Ptã‚’ãƒ­ãƒ¼ãƒ‰ã€æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã§0ã‚’ä»£å…¥
        tutorialMissions = gameState.tutorialMissions || { // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã€æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
            '01': false, '02': false, '03': false, '04': false, '05': false, '06': false, '07': false, '08': false
        };
        islandName = gameState.islandName || "MyIsland";
        monster = gameState.monster;
        actionQueue = gameState.actionQueue || []; // ãƒ­ãƒ¼ãƒ‰æ™‚ã«actionQueueãŒãªã„å ´åˆã«å¯¾å¿œ
        warships = gameState.warships || []; // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
        economicCrisisTurns = gameState.economicCrisisTurns || 0;
        frozenMoney = gameState.frozenMoney || 0;
        volcanoTurns = gameState.volcanoTurns || 0;

        // éå»ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«enhancedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®ãŸã‚ã«åˆæœŸåŒ–
        map.forEach(row => row.forEach(tile => {
            if (tile.enhanced === undefined) {
                tile.enhanced = false;
            }
            if (tile.MonumentLevel === undefined) {
                tile.MonumentLevel = 0;
            }
        }));
        // isDispatchedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®åˆæœŸåŒ–
        warships.forEach(ship => {
            if (ship.isDispatched === undefined) {
                ship.isDispatched = false;
            }
            if (ship.maxFuel === undefined) {
                ship.maxFuel = 100;
            }
            if (ship.abnormality === undefined) { 
                ship.abnormality = null; 
            }
        });

        document.getElementById('islandNameInput').value = islandName; // UIã«ãƒ­ãƒ¼ãƒ‰ã—ãŸåå‰ã‚’åæ˜ 
        isViewingOtherIsland = false; // ãƒ­ãƒ¼ãƒ‰æ™‚ã¯è‡ªåˆ†ã®å³¶ã«ã„ã‚‹
        saveMyIslandState(); // ãƒ­ãƒ¼ãƒ‰ã—ãŸçŠ¶æ…‹ã‚’è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã¨ã—ã¦ä¿å­˜
        logAction("ã‚²ãƒ¼ãƒ ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚");
        renderMap();
        updateStatus();
        document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        updateConfirmButton(); // UIã‚’æ›´æ–°
    } catch (e) {
        logAction("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
        console.error(e);
    }
}

// åˆæœŸåŒ–æ™‚ã«è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆã¾ãŸã¯åˆæœŸåŒ–ï¼‰ã™ã‚‹ã€€
window.onload = function() {
    loadMyIslandState(); // ã¾ãšè‡ªåˆ†ã®å³¶ã‚’ãƒ­ãƒ¼ãƒ‰/åˆæœŸåŒ–
    updateConfirmButton(); // åˆå›UIæ›´æ–°
};
</script></body></html>
